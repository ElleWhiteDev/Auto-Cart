{% extends 'base.html' %}

{% block title %}Shopping Mode - Auto Cart{% endblock %}

{% block content %}
<div class="container mt-4" style="max-width: 600px;">
	<!-- Header -->
	<div class="d-flex justify-content-between align-items-center mb-3">
		<h2><i class="fas fa-shopping-cart"></i> Shopping Mode</h2>
		<a href="{{ url_for('homepage') }}" class="btn btn-outline-secondary">
			<i class="fas fa-times"></i> Exit
		</a>
	</div>

	<!-- List Name -->
	<div class="card shadow mb-3">
		<div class="card-body">
			<h4 class="mb-0">{{ grocery_list.name }}</h4>
			{% if grocery_list.store %}
			<small class="text-muted"><i class="fas fa-store"></i> {{ grocery_list.store }}</small>
			{% endif %}
		</div>
	</div>

	<!-- Progress Bar -->
	<div class="card shadow mb-3">
		<div class="card-body">
			<div class="d-flex justify-content-between align-items-center mb-2">
				<strong>Progress</strong>
				<span class="badge bg-primary">{{ checked_items }} / {{ total_items }}</span>
			</div>
			<div class="progress" style="height: 25px;">
				<div class="progress-bar bg-success" role="progressbar" 
					style="width: {% if total_items > 0 %}{{ (checked_items / total_items * 100)|int }}{% else %}0{% endif %}%"
					aria-valuenow="{{ checked_items }}" 
					aria-valuemin="0" 
					aria-valuemax="{{ total_items }}">
					{% if total_items > 0 %}{{ (checked_items / total_items * 100)|int }}%{% else %}0%{% endif %}
				</div>
			</div>
		</div>
	</div>

	<!-- Shopping Status -->
	<div class="card shadow mb-3">
		<div class="card-body">
			{% if grocery_list.status == 'shopping' %}
				{% if grocery_list.shopping_user_id == g.user.id %}
				<div class="alert alert-success mb-0">
					<i class="fas fa-shopping-cart"></i> <strong>You are shopping this list</strong>
				</div>
				<form method="POST" action="{{ url_for('end_shopping') }}" class="mt-2">
					<button type="submit" class="btn btn-danger w-100">
						<i class="fas fa-stop"></i> End Shopping Session
					</button>
				</form>
				{% else %}
				<div class="alert alert-warning mb-0">
					<i class="fas fa-user"></i> <strong>{{ grocery_list.shopping_user.username }}</strong> is currently shopping this list
				</div>
				{% endif %}
			{% else %}
				<form method="POST" action="{{ url_for('start_shopping') }}">
					<button type="submit" class="btn btn-success w-100 btn-lg">
						<i class="fas fa-play"></i> Start Shopping
					</button>
				</form>
			{% endif %}
		</div>
	</div>

	<!-- Items List -->
	<div class="card shadow mb-4">
		<div class="card-header bg-primary text-white">
			<h5 class="mb-0">Items</h5>
		</div>
		<div class="card-body p-0">
			{% if items %}
			<div class="list-group list-group-flush">
				{% for item in items %}
				<div class="list-group-item shopping-item {% if item.is_checked %}checked{% endif %}" 
					data-item-id="{{ item.id }}">
					<div class="form-check d-flex align-items-center">
						<input 
							class="form-check-input me-3 item-checkbox" 
							type="checkbox" 
							id="item-{{ item.id }}"
							{% if item.is_checked %}checked{% endif %}
							style="width: 30px; height: 30px; cursor: pointer;">
						<label class="form-check-label flex-grow-1" for="item-{{ item.id }}" style="cursor: pointer; font-size: 1.1rem;">
							<div>
								<strong>{{ item.recipe_ingredient.quantity_display }}</strong>
								{{ item.recipe_ingredient.ingredient_name }}
							</div>
							{% if item.recipe_ingredient.recipe %}
							<small class="text-muted">
								<i class="fas fa-utensils"></i> {{ item.recipe_ingredient.recipe.name }}
							</small>
							{% endif %}
						</label>
					</div>
				</div>
				{% endfor %}
			</div>
			{% else %}
			<div class="p-4 text-center text-muted">
				<i class="fas fa-inbox fa-3x mb-3"></i>
				<p>No items in this list</p>
			</div>
			{% endif %}
		</div>
	</div>

	<!-- Last Updated Info -->
	{% if grocery_list.last_modified_by %}
	<div class="text-center text-muted mb-4">
		<small>
			<i class="fas fa-clock"></i> Last updated by 
			<strong>{{ grocery_list.last_modified_by.username }}</strong>
			{% if grocery_list.last_modified_at %}
			{{ grocery_list.last_modified_at.strftime('%I:%M %p') }}
			{% endif %}
		</small>
	</div>
	{% endif %}
</div>

<style>
.shopping-item {
	transition: background-color 0.3s ease;
}

.shopping-item.checked {
	background-color: #f0f0f0;
	opacity: 0.7;
}

.shopping-item.checked label {
	text-decoration: line-through;
	color: #6c757d;
}

.form-check-input:checked {
	background-color: #28a745;
	border-color: #28a745;
}
</style>

<script>
// Handle checkbox clicks
document.querySelectorAll('.item-checkbox').forEach(checkbox => {
	checkbox.addEventListener('change', function() {
		const itemId = this.closest('.shopping-item').dataset.itemId;
		const isChecked = this.checked;
		
		// Toggle the item via AJAX
		fetch(`/shopping-mode/toggle/${itemId}`, {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
			}
		})
		.then(response => response.json())
		.then(data => {
			if (data.success) {
				// Update UI
				const item = this.closest('.shopping-item');
				if (data.is_checked) {
					item.classList.add('checked');
				} else {
					item.classList.remove('checked');
				}
				
				// Reload to update progress
				location.reload();
			}
		})
		.catch(error => {
			console.error('Error:', error);
			// Revert checkbox on error
			this.checked = !isChecked;
		});
	});
});
</script>
{% endblock %}

