{% extends 'base.html' %}

{% block title %}Meal Plan - Auto Cart{% endblock %}

{% block content %}
<style>
	.meal-plan-table {
		border-collapse: separate;
		border-spacing: 0;
		border-radius: 8px;
		overflow: hidden;
	}

	.meal-plan-table thead th {
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.3px;
	}

	.meal-card {
		transition: transform 0.15s, box-shadow 0.15s;
	}

	.meal-card:hover {
		transform: translateY(-1px);
		box-shadow: 0 3px 8px rgba(0,0,0,0.12) !important;
	}

	.date-badge {
		display: inline-block;
		font-weight: 600;
		letter-spacing: 0.3px;
	}

	.meal-link:hover {
		text-decoration: underline !important;
		color: #0a58ca !important;
	}

	/* Clickable day cells */
	.clickable-day {
		transition: background-color 0.2s ease, transform 0.1s ease;
	}

	.clickable-day:hover {
		background-color: rgba(13, 110, 253, 0.08) !important;
		transform: scale(1.02);
	}

	.clickable-day:active {
		transform: scale(0.98);
	}

	/* Mobile-specific styles */
	@media (max-width: 768px) {
		/* Hide table on mobile */
		.desktop-view {
			display: none;
		}

		/* Show mobile card view */
		.mobile-view {
			display: block;
		}

		/* Stack header items vertically */
		.meal-plan-header {
			flex-direction: column !important;
			gap: 0.5rem;
		}

		.meal-plan-header h4 {
			font-size: 1.1rem !important;
		}

		.meal-plan-header .btn-group {
			width: 100%;
		}

		.meal-plan-header .btn {
			font-size: 0.75rem !important;
			padding: 0.25rem 0.5rem !important;
		}

		/* Navigation buttons */
		.week-nav-buttons {
			flex-direction: column !important;
			width: 100%;
		}

		.week-nav-buttons .btn {
			width: 100%;
			margin-bottom: 0.5rem;
		}

		/* Mobile day cards */
		.mobile-day-card {
			margin-bottom: 1rem;
		}

		.mobile-meal-section {
			margin-bottom: 0.75rem;
		}

		.mobile-meal-type-header {
			font-size: 0.85rem;
			font-weight: 600;
			color: #0d6efd;
			margin-bottom: 0.5rem;
			text-transform: uppercase;
		}
	}

	/* Desktop-specific styles */
	@media (min-width: 769px) {
		.mobile-view {
			display: none;
		}

		.desktop-view {
			display: block;
		}
	}
</style>
<div class="container-fluid mt-4">
	<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
		<h1 class="mb-2 mb-md-0"><i class="fas fa-calendar-alt"></i> Meal Plan</h1>
		<div class="week-nav-buttons d-flex gap-2">
			<a href="{{ url_for('meal_plan', week=week_offset-1) }}" class="btn btn-outline-primary btn-sm">
				<i class="fas fa-chevron-left"></i> <span class="d-none d-md-inline">Previous Week</span><span class="d-md-none">Prev</span>
			</a>
			<a href="{{ url_for('meal_plan', week=0) }}" class="btn btn-primary btn-sm">
				<i class="fas fa-calendar-day"></i> <span class="d-none d-md-inline">This Week</span><span class="d-md-none">Today</span>
			</a>
			<a href="{{ url_for('meal_plan', week=week_offset+1) }}" class="btn btn-outline-primary btn-sm">
				<span class="d-none d-md-inline">Next Week</span><span class="d-md-none">Next</span> <i class="fas fa-chevron-right"></i>
			</a>
		</div>
	</div>

	<div class="card shadow mb-4">
		<div class="card-header bg-primary text-white meal-plan-header d-flex justify-content-between align-items-center flex-wrap">
			<h4 class="mb-2 mb-md-0" style="color: white;">
				{{ week_start.strftime('%B %d') }} - {{ week_end.strftime('%B %d, %Y') }}
			</h4>
			<div class="d-flex gap-2">
				<form method="POST" action="{{ url_for('send_meal_plan_email') }}" id="email-meal-plan-form" style="display: inline;">
					<input type="hidden" name="week_offset" value="{{ week_offset }}">
					<button type="submit" id="email-meal-plan-btn" class="btn btn-light btn-sm">
						<i class="fas fa-envelope"></i> <span class="d-none d-md-inline">Email My Meals</span><span class="d-md-none">Email</span>
					</button>
				</form>
				<form method="POST" action="{{ url_for('add_meal_plan_to_list') }}" id="add-to-list-form" style="display: inline;">
					<input type="hidden" name="week_offset" value="{{ week_offset }}">
					<button type="submit" id="add-to-list-btn" class="btn btn-light btn-sm">
						<i class="fas fa-shopping-cart"></i> <span class="d-none d-md-inline">Add All to Grocery List</span><span class="d-md-none">Add All</span>
					</button>
				</form>
			</div>
		</div>
		<div class="card-body p-0">
			<!-- Desktop Table View -->
			<div class="table-responsive desktop-view">
				<table class="table table-hover mb-0 meal-plan-table" style="table-layout: fixed; width: 100%;">
					<thead class="bg-primary text-white">
						<tr>
							<th style="width: 12%; padding: 8px; border: none; font-size: 0.85rem;">Day</th>
							<th style="width: 29.33%; padding: 8px; border: none; font-size: 0.85rem;">Breakfast</th>
							<th style="width: 29.33%; padding: 8px; border: none; font-size: 0.85rem;">Lunch</th>
							<th style="width: 29.34%; padding: 8px; border: none; font-size: 0.85rem;">Dinner</th>
						</tr>
					</thead>
					<tbody>
						{% for date, meals in meal_plan.items() %}
						<tr style="border-bottom: 1px solid #dee2e6;">
							<td class="fw-bold align-middle {% if date == today %}bg-info bg-opacity-10{% endif %} clickable-day"
								style="padding: 10px; border-left: none; border-right: 1px solid #dee2e6; cursor: pointer;"
								data-date="{{ date.strftime('%Y-%m-%d') }}"
								title="Click to add a meal for this day">
								<div style="font-size: 0.9rem;">
									{{ date.strftime('%A') }}
									<span class="text-muted ms-2" style="font-size: 0.85rem; font-weight: 500;">{{ date.strftime('%b %d') }}</span>
								</div>
							</td>
							{% for meal_type in ['breakfast', 'lunch', 'dinner'] %}
							<td class="align-top" style="padding: 8px; background-color: #fafbfc; {% if not loop.last %}border-right: 1px solid #dee2e6;{% endif %}">
								{% for entry in meals[meal_type] %}
								<div class="card mb-2 border-0 shadow-sm meal-card" style="border-left: 3px solid #0d6efd !important; background: white;">
									<div class="card-body p-2">
										<!-- Recipe Title Row -->
										{% if entry.recipe and entry.recipe.url %}
										<div class="fw-bold mb-2" style="font-size: 0.95rem; overflow-x: auto; white-space: nowrap;">
											<a href="{{ entry.recipe.url }}" target="_blank" class="text-primary text-decoration-none meal-link" title="View recipe at {{ entry.recipe.url }}">
												{{ entry.meal_name }} <i class="fas fa-external-link-alt" style="font-size: 0.7rem;"></i>
											</a>
										</div>
										{% else %}
										<div class="fw-bold text-primary mb-2" style="font-size: 0.95rem; overflow-x: auto; white-space: nowrap;">{{ entry.meal_name }}</div>
										{% endif %}

										<!-- Chef and Delete Button Row -->
										<div class="d-flex justify-content-between align-items-center">
											<div class="flex-grow-1">
												{% if entry.assigned_cook %}
												<span class="text-muted" style="font-size: 0.8rem; white-space: nowrap;"><i class="fas fa-utensils"></i> {{ entry.assigned_cook.username }}</span>
												{% endif %}
												{% if entry.notes %}
												<div class="text-info" style="font-size: 0.75rem;"><i class="fas fa-sticky-note"></i> {{ entry.notes }}</div>
												{% endif %}
											</div>
											<form method="POST" action="{{ url_for('delete_meal_plan_entry', entry_id=entry.id) }}" style="display: inline; flex-shrink: 0; margin-left: 4px;">
												<input type="hidden" name="week_offset" value="{{ week_offset }}">
												<button type="submit" class="btn btn-sm btn-outline-danger rounded-circle" onclick="return confirm('Remove this meal?');" style="width: 18px; height: 18px; padding: 0; line-height: 1; font-size: 0.65rem; border-width: 1px;">
													<i class="fas fa-times"></i>
												</button>
											</form>
										</div>
									</div>
								</div>
								{% endfor %}
							</td>
							{% endfor %}
						</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>

		<!-- Mobile Card View -->
		<div class="mobile-view p-3">
			{% for date, meals in meal_plan.items() %}
			<div class="mobile-day-card card mb-3 {% if date == today %}border-info{% endif %}">
				<div class="card-header {% if date == today %}bg-info bg-opacity-10{% else %}bg-light{% endif %} clickable-day"
					style="cursor: pointer;"
					data-date="{{ date.strftime('%Y-%m-%d') }}"
					title="Click to add a meal for this day">
					<div class="d-flex justify-content-between align-items-center">
						<div>
							<span class="fw-bold" style="font-size: 1rem;">{{ date.strftime('%A') }}</span>
							<span class="text-muted ms-2" style="font-size: 0.85rem; font-weight: 500;">{{ date.strftime('%b %d') }}</span>
						</div>
						<i class="fas fa-plus-circle text-success" style="font-size: 1.2rem;"></i>
					</div>
				</div>
				<div class="card-body">
					{% for meal_type in ['breakfast', 'lunch', 'dinner'] %}
					{% if meals[meal_type] %}
					<div class="mobile-meal-section">
						<div class="mobile-meal-type-header">
							{{ meal_type|capitalize }}
						</div>
						{% for entry in meals[meal_type] %}
						<div class="card mb-2 border-0 shadow-sm meal-card" style="border-left: 3px solid #0d6efd !important;">
							<div class="card-body p-2">
								<!-- Recipe Title Row -->
								{% if entry.recipe and entry.recipe.url %}
								<div class="fw-bold mb-2" style="font-size: 0.95rem; overflow-x: auto; white-space: nowrap;">
									<a href="{{ entry.recipe.url }}" target="_blank" class="text-primary text-decoration-none meal-link" title="View recipe at {{ entry.recipe.url }}">
										{{ entry.meal_name }} <i class="fas fa-external-link-alt" style="font-size: 0.7rem;"></i>
									</a>
								</div>
								{% else %}
								<div class="fw-bold text-primary mb-2" style="font-size: 0.95rem; overflow-x: auto; white-space: nowrap;">{{ entry.meal_name }}</div>
								{% endif %}

								<!-- Chef and Delete Button Row -->
								<div class="d-flex justify-content-between align-items-center">
									<div class="flex-grow-1">
										{% if entry.assigned_cook %}
										<span class="text-muted" style="font-size: 0.8rem; white-space: nowrap;"><i class="fas fa-utensils"></i> {{ entry.assigned_cook.username }}</span>
										{% endif %}
										{% if entry.notes %}
										<div class="text-info" style="font-size: 0.75rem;"><i class="fas fa-sticky-note"></i> {{ entry.notes }}</div>
										{% endif %}
									</div>
									<form method="POST" action="{{ url_for('delete_meal_plan_entry', entry_id=entry.id) }}" style="display: inline; flex-shrink: 0; margin-left: 4px;">
										<input type="hidden" name="week_offset" value="{{ week_offset }}">
										<button type="submit" class="btn btn-sm btn-outline-danger rounded-circle" onclick="return confirm('Remove this meal?');" style="width: 18px; height: 18px; padding: 0; line-height: 1; font-size: 0.65rem; border-width: 1px;">
											<i class="fas fa-times"></i>
										</button>
									</form>
								</div>
							</div>
						</div>
						{% endfor %}
					</div>
					{% endif %}
					{% endfor %}

					{% if not meals['breakfast'] and not meals['lunch'] and not meals['dinner'] %}
					<div class="text-muted text-center py-2" style="font-size: 0.85rem;">
						<i class="fas fa-calendar-times"></i> No meals planned
					</div>
					{% endif %}
				</div>
			</div>
			{% endfor %}
		</div>
	</div>
</div>

	<!-- Add Meal Form -->
	<div class="card shadow">
		<div class="card-header bg-success text-white">
			<h5 class="mb-0"><i class="fas fa-plus"></i> Add Meal to Plan</h5>
		</div>
		<div class="card-body">
			<form method="POST" action="{{ url_for('add_meal_plan_entry') }}" id="addMealForm">
				<input type="hidden" name="week_offset" value="{{ week_offset }}">
				<div class="row g-3">
					<div class="col-md-6 col-lg-4">
						<label for="recipe_id" class="form-label" style="font-size: 0.85rem;"><strong>Recipe</strong></label>
						<select name="recipe_id" id="recipe_id" class="form-control w-100" style="font-size: 0.9rem; padding: 0.4rem 0.6rem;" onchange="toggleCustomMeal()">
							<option value="">Select a recipe...</option>
							{% for recipe in recipes %}
							<option value="{{ recipe.id }}">{{ recipe.name }}</option>
							{% endfor %}
							<option value="custom">âž• Add Your Own</option>
						</select>
					</div>
					<div class="col-md-6 col-lg-4" id="customMealDiv" style="display: none;">
						<label for="custom_meal_name" class="form-label" style="font-size: 0.85rem;"><strong>Name</strong></label>
						<input type="text" name="custom_meal_name" id="custom_meal_name" class="form-control w-100" style="font-size: 0.9rem; padding: 0.4rem 0.6rem;" placeholder="e.g., Pizza Night">
					</div>
					<div class="col-md-6 col-lg-4">
						<label for="date" class="form-label" style="font-size: 0.85rem;"><strong>Date</strong></label>
						<input type="date" name="date" id="date" class="form-control w-100" style="font-size: 0.9rem; padding: 0.4rem 0.6rem;" required>
					</div>
					<div class="col-md-6 col-lg-4">
						<label for="meal_type" class="form-label" style="font-size: 0.85rem;"><strong>Meal</strong></label>
						<select name="meal_type" id="meal_type" class="form-control w-100" style="font-size: 0.9rem; padding: 0.4rem 0.6rem;" required>
							<option value="">Select...</option>
							<option value="breakfast">Breakfast</option>
							<option value="lunch">Lunch</option>
							<option value="dinner">Dinner</option>
						</select>
					</div>
					<div class="col-md-6 col-lg-4">
						<label for="assigned_cook_id" class="form-label" style="font-size: 0.85rem;"><strong>Cook</strong></label>
						<select name="assigned_cook_id" id="assigned_cook_id" class="form-control w-100" style="font-size: 0.9rem; padding: 0.4rem 0.6rem;">
							<option value="">Unassigned</option>
							{% for user in household_users %}
							<option value="{{ user.id }}">{{ user.username }}</option>
							{% endfor %}
						</select>
					</div>
					<div class="col-md-6 col-lg-4">
						<label for="notes" class="form-label" style="font-size: 0.85rem;"><strong>Notes</strong></label>
						<input type="text" name="notes" id="notes" class="form-control w-100" style="font-size: 0.9rem; padding: 0.4rem 0.6rem;" placeholder="Optional">
					</div>
					<div class="col-12">
						<button type="submit" id="add-meal-btn" class="btn btn-success w-100" style="font-size: 0.9rem; padding: 0.5rem;">
							<i class="fas fa-plus"></i> Add Meal to Plan
						</button>
					</div>
				</div>
			</form>
		</div>
	</div>
</div>

<script>
// Set default date to today
document.getElementById('date').valueAsDate = new Date();

// Toggle custom meal name field
function toggleCustomMeal() {
	const recipeSelect = document.getElementById('recipe_id');
	const customMealDiv = document.getElementById('customMealDiv');
	const customMealInput = document.getElementById('custom_meal_name');

	if (recipeSelect.value === 'custom') {
		customMealDiv.style.display = 'block';
		customMealInput.required = true;
	} else {
		customMealDiv.style.display = 'none';
		customMealInput.required = false;
		customMealInput.value = '';
	}
}

// Handle clicking on day cells to add meals
document.addEventListener('DOMContentLoaded', function() {
	const clickableDays = document.querySelectorAll('.clickable-day');
	const dateInput = document.getElementById('date');
	const addMealForm = document.getElementById('addMealForm');

	clickableDays.forEach(function(dayCell) {
		dayCell.addEventListener('click', function(e) {
			// Don't trigger if clicking on a button or link inside the cell
			if (e.target.closest('button') || e.target.closest('a') || e.target.closest('form')) {
				return;
			}

			const selectedDate = this.getAttribute('data-date');

			// Set the date in the form
			dateInput.value = selectedDate;

			// Scroll to the form smoothly
			addMealForm.scrollIntoView({ behavior: 'smooth', block: 'center' });

			// Add a brief highlight effect to the form
			addMealForm.style.transition = 'box-shadow 0.3s ease';
			addMealForm.style.boxShadow = '0 0 20px rgba(13, 110, 253, 0.5)';
			setTimeout(function() {
				addMealForm.style.boxShadow = '';
			}, 1500);

			// Focus on the recipe select field
			setTimeout(function() {
				document.getElementById('recipe_id').focus();
			}, 500);
		});
	});
});

// Form validation and processing state for Add Meal form
const addMealForm = document.getElementById('addMealForm');
const addMealBtn = document.getElementById('add-meal-btn');

addMealForm.addEventListener('submit', function(e) {
	const recipeSelect = document.getElementById('recipe_id');
	const customMealInput = document.getElementById('custom_meal_name');

	if (recipeSelect.value === 'custom' && !customMealInput.value.trim()) {
		e.preventDefault();
		alert('Please enter a custom meal name');
		customMealInput.focus();
		return false;
	}

	if (!recipeSelect.value) {
		e.preventDefault();
		alert('Please select a recipe or choose "Add Your Own"');
		recipeSelect.focus();
		return false;
	}

	// Add processing state
	addMealBtn.disabled = true;
	addMealBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Adding...';
});

// Add processing state to Email My Meals button
const emailMealPlanForm = document.getElementById('email-meal-plan-form');
const emailMealPlanBtn = document.getElementById('email-meal-plan-btn');

if (emailMealPlanForm && emailMealPlanBtn) {
	emailMealPlanForm.addEventListener('submit', function() {
		emailMealPlanBtn.disabled = true;
		emailMealPlanBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Sending...';
	});
}

// Add processing state to Add All to Grocery List button
const addToListForm = document.getElementById('add-to-list-form');
const addToListBtn = document.getElementById('add-to-list-btn');

if (addToListForm && addToListBtn) {
	addToListForm.addEventListener('submit', function() {
		addToListBtn.disabled = true;
		addToListBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Adding...';
	});
}
</script>
{% endblock %}
