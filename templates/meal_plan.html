{% extends 'base.html' %}

{% block title %}Meal Plan - Auto Cart{% endblock %}

{% block content %}
<style>
	.meal-plan-table {
		border-collapse: separate;
		border-spacing: 0;
		border-radius: 0;
		overflow: hidden;
	}

	.meal-plan-table thead th {
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.5px;
		font-size: 0.7rem;
		padding: 10px 8px !important;
		background: #f97316 !important;
		border: none !important;
		color: white !important;
	}

	.meal-plan-table tbody tr {
		border-bottom: 1px solid #e5e7eb;
		transition: background-color 0.15s ease;
	}

	.meal-plan-table tbody tr:hover {
		background-color: #f9fafb;
	}

	.meal-plan-table tbody td {
		padding: 6px !important;
		vertical-align: top;
	}

	.meal-card {
		transition: all 0.15s ease;
		border-radius: 6px !important;
		border: 1px solid #e5e7eb !important;
		border-left: 2px solid #3b82f6 !important;
		margin-bottom: 6px !important;
	}

	.desktop-view .meal-card[draggable="true"] {
		cursor: grab;
	}

	.desktop-view .meal-card.dragging {
		opacity: 0.55;
		transform: scale(0.98);
	}

	.desktop-view .meal-drop-zone {
		transition: background-color 0.15s ease, outline-color 0.15s ease;
	}

	.desktop-view .meal-drop-zone.drag-over {
		background-color: #eff6ff !important;
		outline: 2px dashed #60a5fa;
		outline-offset: -2px;
	}

	.desktop-meal-actions {
		display: flex;
		gap: 4px;
		flex-shrink: 0;
		margin-left: 6px;
		align-items: center;
	}

	.desktop-meal-actions form {
		margin: 0;
		display: flex;
		align-items: center;
	}

	.desktop-action-btn {
		width: 22px;
		min-width: 22px;
		height: 22px;
		min-height: 22px !important;
		padding: 0 !important;
		display: flex !important;
		align-items: center;
		justify-content: center;
		line-height: 1 !important;
		font-size: 0.7rem !important;
		border-width: 1px !important;
		border-style: solid;
		border-radius: 4px !important;
		box-sizing: border-box;
		background: #ffffff;
		cursor: pointer;
		appearance: none;
		-webkit-appearance: none;
		transition: all 0.15s ease;
	}

	.desktop-action-btn-edit {
		border-color: #d1d5db;
		color: #6b7280;
	}

	.desktop-action-btn-delete {
		border-color: #fecaca;
		color: #dc2626;
	}

	.desktop-action-btn i {
		display: flex;
		align-items: center;
		justify-content: center;
		width: 1em;
		height: 1em;
		line-height: 1;
		pointer-events: none;
	}

	.meal-card:hover {
		transform: translateY(-1px);
		box-shadow: 0 2px 8px rgba(0,0,0,0.08) !important;
		border-left-color: #2563eb !important;
	}

	.meal-link {
		color: #1e40af;
		transition: color 0.15s ease;
	}

	.meal-link:hover {
		color: #1e3a8a !important;
		text-decoration: none !important;
	}

	/* Clickable day header cells */
	.clickable-day-header {
		transition: all 0.15s ease;
		position: relative;
	}

	.clickable-day-header:hover {
		background-color: #ea580c !important;
		transform: translateY(-1px);
	}

	.clickable-day-header:active {
		transform: translateY(0);
	}

	.day-name {
		font-size: 0.75rem;
		font-weight: 600;
		color: white;
		line-height: 1.2;
		text-transform: uppercase;
		letter-spacing: 0.3px;
	}

	.day-date {
		font-size: 0.7rem;
		color: rgba(255, 255, 255, 0.9);
		font-weight: 500;
		margin-top: 2px;
	}

	.add-meal-icon {
		position: absolute;
		top: 50%;
		right: 8px;
		transform: translateY(-50%);
		font-size: 1rem;
		color: white;
		opacity: 0.7;
		transition: opacity 0.15s ease;
	}

	.clickable-day:hover .add-meal-icon {
		opacity: 1;
	}

	/* Multi-select styling */
	#assigned_cook_ids {
		background-color: white;
		border: 1px solid #ced4da;
	}

	#assigned_cook_ids option {
		padding: 6px 8px;
		border-radius: 3px;
		margin: 2px 0;
	}

	#assigned_cook_ids option:checked {
		background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
		color: white;
		font-weight: 500;
	}

	/* Inline edit mode styling */
	.chef-display {
		display: block;
	}

	.chef-edit {
		display: none;
	}

	.meal-card.editing .chef-display {
		display: none;
	}

	.meal-card.editing .chef-edit {
		display: block;
	}

	.edit-cook-select {
		font-size: 0.75rem;
		padding: 2px 4px;
		min-height: 60px;
	}

	.edit-cook-select option:checked {
		background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
		color: white;
		font-weight: 500;
	}

	.mobile-meal-actions {
		display: flex;
		gap: 6px;
		flex-shrink: 0;
		margin-left: 6px;
		align-items: center;
	}

	.mobile-meal-actions form {
		margin: 0;
		display: flex;
		align-items: center;
	}

	.mobile-action-btn {
		width: 28px;
		min-width: 28px;
		height: 28px;
		min-height: 28px !important;
		min-width: 28px !important;
		padding: 0 !important;
		display: flex !important;
		align-items: center;
		justify-content: center;
		line-height: 1 !important;
		font-size: 0.75rem !important;
		border-width: 1px !important;
		border-style: solid;
		border-radius: 6px !important;
		box-sizing: border-box;
		background: #ffffff;
		cursor: pointer;
		appearance: none;
		-webkit-appearance: none;
	}

	.mobile-action-btn-edit {
		border-color: #93c5fd;
		color: #1d4ed8;
	}

	.mobile-action-btn-delete {
		border-color: #fecaca;
		color: #dc2626;
	}

	.mobile-action-btn i {
		display: flex;
		align-items: center;
		justify-content: center;
		width: 1em;
		height: 1em;
		line-height: 1;
		pointer-events: none;
		font-size: 0.8rem;
	}

	/* Mobile-specific styles */
	@media (max-width: 768px) {
		/* Hide table on mobile */
		.desktop-view {
			display: none;
		}

		/* Show mobile card view */
		.mobile-view {
			display: block;
		}

		/* Stack header items vertically */
		.meal-plan-header {
			flex-direction: column !important;
			gap: 0.5rem;
		}

		.meal-plan-header h4 {
			font-size: 1.1rem !important;
		}

		.meal-plan-header .btn-group {
			width: 100%;
		}

		.meal-plan-header .btn {
			font-size: 0.75rem !important;
			padding: 0.25rem 0.5rem !important;
		}

		/* Navigation buttons */
		.week-nav-buttons {
			flex-direction: column !important;
			width: 100%;
		}

		.week-nav-buttons .btn {
			width: 100%;
			margin-bottom: 0.5rem;
		}

		/* Mobile day cards */
		.mobile-day-card {
			margin-bottom: 1rem;
		}

		.mobile-meal-section {
			margin-bottom: 0.75rem;
		}

		.mobile-meal-type-header {
			font-size: 0.85rem;
			font-weight: 600;
			color: #0d6efd;
			margin-bottom: 0.5rem;
			text-transform: uppercase;
		}
	}

	/* Desktop-specific styles */
	@media (min-width: 769px) {
		.mobile-view {
			display: none;
		}

		.desktop-view {
			display: block;
		}
	}
</style>
<div class="container-fluid mt-4">
	<div id="meal-plan-notification-anchor" class="mb-4"></div>
	<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
		<h1 class="mb-2 mb-md-0"><i class="fas fa-calendar-alt"></i> Meal Plan</h1>
		<div class="week-nav-buttons d-flex gap-2">
			<a href="{{ url_for('meal_plan', week=week_offset-1) }}" class="btn btn-outline-primary btn-sm">
				<i class="fas fa-chevron-left"></i> <span class="d-none d-md-inline">Previous Week</span><span class="d-md-none">Prev</span>
			</a>
			<a href="{{ url_for('meal_plan', week=0) }}" class="btn btn-primary btn-sm">
				<i class="fas fa-calendar-day"></i> <span class="d-none d-md-inline">This Week</span><span class="d-md-none">Today</span>
			</a>
			<a href="{{ url_for('meal_plan', week=week_offset+1) }}" class="btn btn-outline-primary btn-sm">
				<span class="d-none d-md-inline">Next Week</span><span class="d-md-none">Next</span> <i class="fas fa-chevron-right"></i>
			</a>
		</div>
	</div>

	<div class="card shadow mb-4">
		<div class="card-header bg-primary text-white meal-plan-header d-flex justify-content-between align-items-center flex-wrap">
			<h4 class="mb-2 mb-md-0" style="color: white;">
				{{ week_start.strftime('%B %d') }} - {{ week_end.strftime('%B %d, %Y') }}
			</h4>
			<div class="d-flex gap-2">
				<form method="POST" action="{{ url_for('send_meal_plan_email') }}" id="email-meal-plan-form" style="display: inline;">
					<input type="hidden" name="week_offset" value="{{ week_offset }}">
					<button type="submit" id="email-meal-plan-btn" class="btn btn-light btn-sm">
						<i class="fas fa-envelope"></i> <span class="d-none d-md-inline">Email My Meals</span><span class="d-md-none">Email</span>
					</button>
				</form>
				<button type="button" id="similar-recipes-btn" class="btn btn-light btn-sm" onclick="findSimilarRecipes()">
					<i class="fas fa-lightbulb"></i> <span class="d-none d-md-inline">Similar Recipes</span><span class="d-md-none">Similar</span>
				</button>
				<form method="POST" action="{{ url_for('add_meal_plan_to_list') }}" id="add-to-list-form" style="display: inline;">
					<input type="hidden" name="week_offset" value="{{ week_offset }}">
					<button type="submit" id="add-to-list-btn" class="btn btn-light btn-sm">
						<i class="fas fa-shopping-cart"></i> <span class="d-none d-md-inline">Add All to Grocery List</span><span class="d-md-none">Add All</span>
					</button>
				</form>
			</div>
		</div>
		<div class="card-body p-0">
			<!-- Desktop Table View -->
			<div class="table-responsive desktop-view">
				<table class="table mb-0 meal-plan-table" style="table-layout: fixed; width: 100%;">
					<thead>
						<tr>
							<th style="width: 10%;">Meal</th>
							{% for date, meals in meal_plan.items() %}
							<th style="width: 12.86%; cursor: pointer; position: relative;"
								class="clickable-day-header"
								data-date="{{ date.strftime('%Y-%m-%d') }}"
								title="Click to add a meal for this day">
								<div class="day-name">{{ date.strftime('%a') }}</div>
								<div class="day-date">{{ date.strftime('%b %d') }}</div>
								<i class="fas fa-plus add-meal-icon"></i>
							</th>
							{% endfor %}
						</tr>
					</thead>
					<tbody>
						{% for meal_type in ['breakfast', 'lunch', 'dinner'] %}
						<tr>
							<td class="clickable-meal-type" style="font-weight: 600; font-size: 0.8rem; color: #1f2937;">
								{% if meal_type == 'breakfast' %}üç≥ Breakfast{% endif %}
								{% if meal_type == 'lunch' %}ü•ó Lunch{% endif %}
								{% if meal_type == 'dinner' %}üçΩÔ∏è Dinner{% endif %}
							</td>
							{% for date, meals in meal_plan.items() %}
							<td class="meal-drop-zone"
								data-date="{{ date.strftime('%Y-%m-%d') }}"
								data-meal-type="{{ meal_type }}"
								style="background-color: #f9fafb; {% if not loop.last %}border-right: 1px solid #e5e7eb;{% endif %}">
								{% for entry in meals[meal_type] %}
								<div class="meal-card"
									id="meal-card-{{ entry.id }}"
									data-entry-id="{{ entry.id }}"
									draggable="true"
									style="background: white;">
									<div style="padding: 8px;">
										<!-- Recipe Title Row -->
										{% if entry.recipe and entry.recipe.url %}
										<div class="mb-1" style="font-size: 0.8rem; font-weight: 600; color: #111827; line-height: 1.3;">
											<a href="{{ entry.recipe.url }}" target="_blank" class="meal-link text-decoration-none" title="View recipe">
												{{ entry.meal_name }} <i class="fas fa-external-link-alt" style="font-size: 0.6rem; opacity: 0.5;"></i>
											</a>
										</div>
										{% else %}
										<div class="mb-1" style="font-size: 0.8rem; font-weight: 600; color: #1e40af; line-height: 1.3;">{{ entry.meal_name }}</div>
										{% endif %}

										<!-- Chef Display Mode (default) -->
										<div class="chef-display">
											<div class="d-flex justify-content-between align-items-start">
												<div class="flex-grow-1" style="min-width: 0;">
													{% if entry.assigned_cooks.count() > 0 %}
													<div style="font-size: 0.7rem; color: #6b7280; margin-bottom: 2px;">
														<i class="fas fa-utensils" style="width: 11px; opacity: 0.6; font-size: 0.65rem; margin-right: 4px;"></i>
														<span style="font-weight: 500;">
															{% for cook in entry.assigned_cooks %}{{ cook.username }}{% if not loop.last %}, {% endif %}{% endfor %}
														</span>
													</div>
													{% elif entry.assigned_cook %}
													<div style="font-size: 0.7rem; color: #6b7280; margin-bottom: 2px;">
														<i class="fas fa-utensils" style="width: 11px; opacity: 0.6; font-size: 0.65rem; margin-right: 4px;"></i>
														<span style="font-weight: 500;">{{ entry.assigned_cook.username }}</span>
													</div>
													{% endif %}
													{% if entry.notes %}
													<div style="font-size: 0.65rem; color: #059669; background-color: #d1fae5; padding: 2px 6px; border-radius: 3px; display: inline-block; margin-top: 2px;">
														<i class="fas fa-sticky-note" style="font-size: 0.6rem;"></i> {{ entry.notes }}
													</div>
													{% endif %}
												</div>
													<div class="desktop-meal-actions">
														<!-- Edit Button -->
														<button type="button" class="edit-meal-btn desktop-action-btn desktop-action-btn-edit" data-entry-id="{{ entry.id }}">
															<i class="fas fa-edit"></i>
														</button>
														<!-- Delete Button -->
														<form method="POST" action="{{ url_for('delete_meal_plan_entry', entry_id=entry.id) }}">
															<input type="hidden" name="week_offset" value="{{ week_offset }}">
															<button type="submit" class="desktop-action-btn desktop-action-btn-delete" onclick="return confirm('Remove this meal from the plan?');">
																<i class="fas fa-times"></i>
															</button>
														</form>
												</div>
											</div>
										</div>

										<!-- Chef Edit Mode (hidden by default) -->
										<div class="chef-edit">
											<form method="POST" action="{{ url_for('update_meal_plan_entry', entry_id=entry.id) }}" class="edit-meal-form">
												<input type="hidden" name="week_offset" value="{{ week_offset }}">
												<div class="mb-2">
													<label style="font-size: 0.75rem; font-weight: 600; margin-bottom: 2px;">Assigned Cooks:</label>
													<select name="assigned_cook_ids" class="form-control edit-cook-select" multiple>
														{% for user in household_users %}
														<option value="{{ user.id }}" {% if user in entry.assigned_cooks %}selected{% endif %}>
															{{ user.username }}
														</option>
														{% endfor %}
													</select>
													<small class="text-muted" style="font-size: 0.65rem;">Hold Ctrl/Cmd for multiple. Removed chefs will be emailed.</small>
												</div>
												<div class="d-flex gap-1">
													<button type="submit" class="btn btn-sm btn-success" style="font-size: 0.7rem; padding: 2px 8px;">
														<i class="fas fa-check"></i> Save
													</button>
													<button type="button" class="btn btn-sm btn-secondary cancel-edit-btn" data-entry-id="{{ entry.id }}" style="font-size: 0.7rem; padding: 2px 8px;">
														<i class="fas fa-times"></i> Cancel
													</button>
												</div>
											</form>
										</div>
									</div>
								</div>
								{% endfor %}
							</td>
							{% endfor %}
						</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>

		<!-- Mobile Card View -->
		<div class="mobile-view p-3">
			{% for date, meals in meal_plan.items() %}
			<div class="mobile-day-card card mb-3 {% if date == today %}border-info{% endif %}">
				<div class="card-header {% if date == today %}bg-info bg-opacity-10{% else %}bg-light{% endif %} clickable-day"
					style="cursor: pointer;"
					data-date="{{ date.strftime('%Y-%m-%d') }}"
					title="Click to add a meal for this day">
					<div class="d-flex justify-content-between align-items-center">
						<div>
							<span class="fw-bold" style="font-size: 1rem;">{{ date.strftime('%A') }}</span>
							<span class="text-muted ms-2" style="font-size: 0.85rem; font-weight: 500;">{{ date.strftime('%b %d') }}</span>
						</div>
						<i class="fas fa-plus-circle text-success" style="font-size: 1.2rem;"></i>
					</div>
				</div>
				<div class="card-body">
					{% for meal_type in ['breakfast', 'lunch', 'dinner'] %}
					{% if meals[meal_type] %}
					<div class="mobile-meal-section">
						<div class="mobile-meal-type-header">
							{{ meal_type|capitalize }}
						</div>
						{% for entry in meals[meal_type] %}
						<div class="card mb-2 border-0 shadow-sm meal-card" id="meal-card-mobile-{{ entry.id }}" style="border-left: 3px solid #0d6efd !important;">
							<div class="card-body p-2">
								<!-- Recipe Title Row -->
								{% if entry.recipe and entry.recipe.url %}
								<div class="fw-bold mb-2" style="font-size: 0.95rem; overflow-x: auto; white-space: nowrap;">
									<a href="{{ entry.recipe.url }}" target="_blank" class="text-primary text-decoration-none meal-link" title="View recipe at {{ entry.recipe.url }}">
										{{ entry.meal_name }} <i class="fas fa-external-link-alt" style="font-size: 0.7rem;"></i>
									</a>
								</div>
								{% else %}
								<div class="fw-bold text-primary mb-2" style="font-size: 0.95rem; overflow-x: auto; white-space: nowrap;">{{ entry.meal_name }}</div>
								{% endif %}

								<!-- Chef Display Mode (default) -->
								<div class="chef-display">
									<div class="d-flex justify-content-between align-items-center">
										<div class="flex-grow-1">
											{% if entry.assigned_cooks.count() > 0 %}
											<span class="text-muted" style="font-size: 0.8rem;">
												<i class="fas fa-utensils"></i>
												{% for cook in entry.assigned_cooks %}{{ cook.username }}{% if not loop.last %}, {% endif %}{% endfor %}
											</span>
											{% elif entry.assigned_cook %}
											<span class="text-muted" style="font-size: 0.8rem; white-space: nowrap;"><i class="fas fa-utensils"></i> {{ entry.assigned_cook.username }}</span>
											{% endif %}
											{% if entry.notes %}
											<div class="text-info" style="font-size: 0.75rem;"><i class="fas fa-sticky-note"></i> {{ entry.notes }}</div>
											{% endif %}
										</div>
										<div class="mobile-meal-actions">
											<!-- Edit Button -->
											<button type="button" class="edit-meal-btn mobile-action-btn mobile-action-btn-edit" data-entry-id="{{ entry.id }}" data-mobile="true">
												<i class="fas fa-edit"></i>
											</button>
											<!-- Delete Button -->
												<form method="POST" action="{{ url_for('delete_meal_plan_entry', entry_id=entry.id) }}">
													<input type="hidden" name="week_offset" value="{{ week_offset }}">
														<button type="submit" class="mobile-action-btn mobile-action-btn-delete" onclick="return confirm('Remove this meal from the plan?');">
															<i class="fas fa-times"></i>
														</button>
												</form>
										</div>
									</div>
								</div>

								<!-- Chef Edit Mode (hidden by default) -->
								<div class="chef-edit">
									<form method="POST" action="{{ url_for('update_meal_plan_entry', entry_id=entry.id) }}" class="edit-meal-form">
										<input type="hidden" name="week_offset" value="{{ week_offset }}">
										<div class="mb-2 d-md-none">
											<label style="font-size: 0.75rem; font-weight: 600; margin-bottom: 2px;">Date:</label>
											<input type="date" name="date" class="form-control form-control-sm" value="{{ entry.date.strftime('%Y-%m-%d') }}">
										</div>
										<div class="mb-2">
											<label style="font-size: 0.75rem; font-weight: 600; margin-bottom: 2px;">Assigned Cooks:</label>
											<select name="assigned_cook_ids" class="form-control edit-cook-select" multiple>
												{% for user in household_users %}
												<option value="{{ user.id }}" {% if user in entry.assigned_cooks %}selected{% endif %}>
													{{ user.username }}
												</option>
												{% endfor %}
											</select>
											<small class="text-muted" style="font-size: 0.65rem;">Hold Ctrl/Cmd for multiple. Removed chefs will be emailed.</small>
										</div>
										<div class="d-flex gap-1">
											<button type="submit" class="btn btn-sm btn-success" style="font-size: 0.7rem; padding: 2px 8px;">
												<i class="fas fa-check"></i> Save
											</button>
											<button type="button" class="btn btn-sm btn-secondary cancel-edit-btn" data-entry-id="{{ entry.id }}" data-mobile="true" style="font-size: 0.7rem; padding: 2px 8px;">
												<i class="fas fa-times"></i> Cancel
											</button>
										</div>
									</form>
								</div>
							</div>
						</div>
						{% endfor %}
					</div>
					{% endif %}
					{% endfor %}

					{% if not meals['breakfast'] and not meals['lunch'] and not meals['dinner'] %}
					<div class="text-muted text-center py-2" style="font-size: 0.85rem;">
						<i class="fas fa-calendar-times"></i> No meals planned
					</div>
					{% endif %}
				</div>
			</div>
			{% endfor %}
		</div>
	</div>
</div>

	<!-- Add Meal Form -->
	<div class="card shadow">
		<div class="card-header bg-success text-white">
			<h5 class="mb-0"><i class="fas fa-plus"></i> Add Meal to Plan</h5>
		</div>
		<div class="card-body">
			<form method="POST" action="{{ url_for('add_meal_plan_entry') }}" id="addMealForm">
				<input type="hidden" name="week_offset" value="{{ week_offset }}">
				<div class="row g-3">
					<div class="col-md-6 col-lg-4">
						<label for="recipe_id" class="form-label" style="font-size: 0.85rem;"><strong>Recipe</strong></label>
						<select name="recipe_id" id="recipe_id" class="form-control w-100" style="font-size: 0.9rem; padding: 0.4rem 0.6rem;" onchange="toggleCustomMeal()">
							<option value="">Select a recipe...</option>
							{% for recipe in recipes %}
							<option value="{{ recipe.id }}">{{ recipe.name }}</option>
							{% endfor %}
							<option value="custom">‚ûï Add Your Own</option>
						</select>
					</div>
					<div class="col-md-6 col-lg-4" id="customMealDiv" style="display: none;">
						<label for="custom_meal_name" class="form-label" style="font-size: 0.85rem;"><strong>Name</strong></label>
						<input type="text" name="custom_meal_name" id="custom_meal_name" class="form-control w-100" style="font-size: 0.9rem; padding: 0.4rem 0.6rem;" placeholder="e.g., Pizza Night">
					</div>
					<div class="col-md-6 col-lg-4">
						<label for="date" class="form-label" style="font-size: 0.85rem;"><strong>Date</strong></label>
						<input type="date" name="date" id="date" class="form-control w-100" style="font-size: 0.9rem; padding: 0.4rem 0.6rem;" required>
					</div>
					<div class="col-md-6 col-lg-4">
						<label for="meal_type" class="form-label" style="font-size: 0.85rem;"><strong>Meal</strong></label>
						<select name="meal_type" id="meal_type" class="form-control w-100" style="font-size: 0.9rem; padding: 0.4rem 0.6rem;" required>
							<option value="" disabled selected>Select...</option>
							<option value="breakfast">Breakfast</option>
							<option value="lunch">Lunch</option>
							<option value="dinner">Dinner</option>
						</select>
					</div>
					<div class="col-md-6 col-lg-4">
						<label for="assigned_cook_ids" class="form-label" style="font-size: 0.85rem;"><strong>Cooks</strong> <small class="text-muted">(hold Ctrl/Cmd to select multiple)</small></label>
						<select name="assigned_cook_ids" id="assigned_cook_ids" class="form-control w-100" style="font-size: 0.9rem; padding: 0.4rem 0.6rem; min-height: 80px;" multiple>
							{% for user in household_users %}
							<option value="{{ user.id }}">{{ user.username }}</option>
							{% endfor %}
						</select>
					</div>
					<div class="col-md-6 col-lg-4">
						<label for="notes" class="form-label" style="font-size: 0.85rem;"><strong>Notes</strong></label>
						<input type="text" name="notes" id="notes" class="form-control w-100" style="font-size: 0.9rem; padding: 0.4rem 0.6rem;" placeholder="Optional">
					</div>
					<div class="col-12">
						<button type="submit" id="add-meal-btn" class="btn btn-success w-100" style="font-size: 0.9rem; padding: 0.5rem;">
							<i class="fas fa-plus"></i> Add Meal to Plan
						</button>
					</div>
				</div>
			</form>
		</div>
	</div>
</div>

<!-- Similar Recipes Modal -->
<style>
.modal {
	display: none;
	position: fixed;
	z-index: 1050;
	left: 0;
	top: 0;
	width: 100%;
	height: 100%;
	overflow: auto;
	background-color: rgba(0,0,0,0.5);
}

.modal.show {
	display: block;
}

.modal-dialog {
	position: relative;
	width: auto;
	max-width: 800px;
	margin: 1.75rem auto;
}

.modal-content {
	position: relative;
	background-color: #fff;
	border: 1px solid rgba(0,0,0,.2);
	border-radius: 0.3rem;
	box-shadow: 0 0.5rem 1rem rgba(0,0,0,.5);
}

.modal-header {
	display: flex;
	align-items: center;
	justify-content: space-between;
	padding: 1rem;
	border-bottom: 1px solid #dee2e6;
}

.modal-title {
	margin: 0;
	font-size: 1.25rem;
	font-weight: 500;
}

.modal-body {
	position: relative;
	padding: 1rem;
	max-height: 60vh;
	overflow-y: auto;
}

.modal-footer {
	display: flex;
	align-items: center;
	justify-content: flex-end;
	padding: 1rem;
	border-top: 1px solid #dee2e6;
	gap: 0.5rem;
}

.btn-close {
	background: transparent;
	border: 0;
	font-size: 1.5rem;
	font-weight: 700;
	line-height: 1;
	color: #000;
	opacity: .5;
	cursor: pointer;
}

.btn-close:hover {
	opacity: .75;
}

.modal-backdrop {
	position: fixed;
	top: 0;
	left: 0;
	z-index: 1040;
	width: 100vw;
	height: 100vh;
	background-color: #000;
	opacity: 0.5;
}

.spinner-border {
	display: inline-block;
	width: 2rem;
	height: 2rem;
	vertical-align: text-bottom;
	border: 0.25em solid currentColor;
	border-right-color: transparent;
	border-radius: 50%;
	animation: spinner-border .75s linear infinite;
}

.spinner-border-sm {
	width: 1rem;
	height: 1rem;
	border-width: 0.2em;
}

.text-primary {
	color: #f97316 !important;
}

@keyframes spinner-border {
	to { transform: rotate(360deg); }
}
</style>

<div class="modal" id="similarRecipesModal" tabindex="-1" aria-labelledby="similarRecipesModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="similarRecipesModalLabel">
					<i class="fas fa-lightbulb"></i> Similar Recipes
				</h5>
				<button type="button" class="btn-close" onclick="closeSimilarRecipesModal()" aria-label="Close">&times;</button>
			</div>
			<div class="modal-body">
				<!-- Loading state -->
				<div id="similar-recipes-loading" class="text-center py-5">
					<div class="spinner-border text-primary" role="status">
						<span class="visually-hidden">Loading...</span>
					</div>
					<p style="margin-top: 1rem; color: #6c757d;">Finding recipes that match your shopping list...</p>
				</div>

				<!-- Warning message -->
				<div id="similar-recipes-warning" class="alert alert-info" style="display: none; padding: 1rem; background-color: #d1ecf1; border: 1px solid #bee5eb; border-radius: 0.25rem; color: #0c5460;">
					<i class="fas fa-info-circle"></i> <strong>Note:</strong> Any recipes added this way will have ingredients automatically added to the grocery list.
				</div>

				<!-- No results message -->
				<div id="similar-recipes-empty" class="text-center py-5" style="display: none;">
					<i class="fas fa-search" style="font-size: 3rem; color: #6c757d;"></i>
					<p style="margin-top: 1rem; color: #6c757d;">No matching recipes found. Try adding more meals to your plan first!</p>
				</div>

				<!-- Results container -->
				<div id="similar-recipes-results" style="display: none;">
					<div id="similarRecipesAccordion">
						<!-- Recipe items will be inserted here -->
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" onclick="closeSimilarRecipesModal()">Cancel</button>
				<button type="button" class="btn btn-primary" id="apply-similar-recipes-btn" onclick="applySimilarRecipes()" style="display: none;">
					<i class="fas fa-check"></i> Apply
				</button>
			</div>
		</div>
	</div>
</div>

<script>
// Set default date to today
document.getElementById('date').valueAsDate = new Date();

// Toggle custom meal name field
function toggleCustomMeal() {
	const recipeSelect = document.getElementById('recipe_id');
	const customMealDiv = document.getElementById('customMealDiv');
	const customMealInput = document.getElementById('custom_meal_name');

	if (recipeSelect.value === 'custom') {
		customMealDiv.style.display = 'block';
		customMealInput.required = true;
	} else {
		customMealDiv.style.display = 'none';
		customMealInput.required = false;
		customMealInput.value = '';
	}
}

// Handle clicking on day header cells to add meals (both desktop and mobile)
document.addEventListener('DOMContentLoaded', function() {
	const clickableDayHeaders = document.querySelectorAll('.clickable-day-header, .clickable-day');
	const dateInput = document.getElementById('date');
	const addMealForm = document.getElementById('addMealForm');

	clickableDayHeaders.forEach(function(dayHeader) {
		dayHeader.addEventListener('click', function(e) {
			const selectedDate = this.getAttribute('data-date');

			// Set the date in the form
			dateInput.value = selectedDate;

			// Scroll to the form smoothly
			addMealForm.scrollIntoView({ behavior: 'smooth', block: 'center' });

			// Add a brief highlight effect to the form
			addMealForm.style.transition = 'box-shadow 0.3s ease';
			addMealForm.style.boxShadow = '0 0 20px rgba(13, 110, 253, 0.5)';
			setTimeout(function() {
				addMealForm.style.boxShadow = '';
			}, 1500);

			// Focus on the recipe select field
			setTimeout(function() {
				document.getElementById('recipe_id').focus();
			}, 500);
		});
	});
});

// Form validation and processing state for Add Meal form
const addMealForm = document.getElementById('addMealForm');
const addMealBtn = document.getElementById('add-meal-btn');

addMealForm.addEventListener('submit', function(e) {
	const recipeSelect = document.getElementById('recipe_id');
	const customMealInput = document.getElementById('custom_meal_name');

	if (recipeSelect.value === 'custom' && !customMealInput.value.trim()) {
		e.preventDefault();
		alert('Please enter a custom meal name');
		customMealInput.focus();
		return false;
	}

	if (!recipeSelect.value) {
		e.preventDefault();
		alert('Please select a recipe or choose "Add Your Own"');
		recipeSelect.focus();
		return false;
	}

	// Add processing state
	addMealBtn.disabled = true;
	addMealBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Adding...';
});

// Add processing state to Email My Meals button
const emailMealPlanForm = document.getElementById('email-meal-plan-form');
const emailMealPlanBtn = document.getElementById('email-meal-plan-btn');

if (emailMealPlanForm && emailMealPlanBtn) {
	emailMealPlanForm.addEventListener('submit', function() {
		emailMealPlanBtn.disabled = true;
		emailMealPlanBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Sending...';
	});
}

// Add processing state to Add All to Grocery List button
const addToListForm = document.getElementById('add-to-list-form');
const addToListBtn = document.getElementById('add-to-list-btn');

if (addToListForm && addToListBtn) {
	addToListForm.addEventListener('submit', function() {
		addToListBtn.disabled = true;
		addToListBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Adding...';
	});
}

// Inline edit functionality for meal cards
document.addEventListener('DOMContentLoaded', function() {
	const isDesktop = window.matchMedia('(min-width: 769px)').matches;
	const weekOffset = {{ week_offset|tojson }};
	const mealTypeLabels = {
		breakfast: 'Breakfast',
		lunch: 'Lunch',
		dinner: 'Dinner'
	};

	function showPlannerSuccess(message) {
		const notificationAnchor = document.getElementById('meal-plan-notification-anchor');
		if (!notificationAnchor) return;

		notificationAnchor.innerHTML = '';

		const flashDiv = document.createElement('div');
		flashDiv.className = 'alert alert-success';
		flashDiv.setAttribute('role', 'alert');
		flashDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
		notificationAnchor.appendChild(flashDiv);
		setTimeout(() => flashDiv.remove(), 5000);
	}

	function getWeekdayLabel(dateIso) {
		if (!dateIso) return '';
		const parts = dateIso.split('-');
		if (parts.length !== 3) return '';
		const year = parseInt(parts[0], 10);
		const month = parseInt(parts[1], 10) - 1;
		const day = parseInt(parts[2], 10);
		const dateObj = new Date(year, month, day);
		if (Number.isNaN(dateObj.getTime())) return '';
		return dateObj.toLocaleDateString(undefined, { weekday: 'long' });
	}

	function clearDropHighlights() {
		document.querySelectorAll('.meal-drop-zone.drag-over').forEach(zone => {
			zone.classList.remove('drag-over');
		});
	}

	if (isDesktop) {
		let draggingCard = null;

		document.querySelectorAll('.desktop-view .meal-card[draggable="true"]').forEach(card => {
			card.addEventListener('dragstart', function(e) {
				if (this.classList.contains('editing')) {
					e.preventDefault();
					return;
				}
				draggingCard = this;
				this.classList.add('dragging');
				e.dataTransfer.effectAllowed = 'move';
				e.dataTransfer.setData('text/plain', this.dataset.entryId || '');
			});

			card.addEventListener('dragend', function() {
				this.classList.remove('dragging');
				draggingCard = null;
				clearDropHighlights();
			});
		});

		document.querySelectorAll('.desktop-view .meal-drop-zone').forEach(zone => {
			zone.addEventListener('dragover', function(e) {
				if (!draggingCard) return;
				e.preventDefault();
				e.dataTransfer.dropEffect = 'move';
				this.classList.add('drag-over');
			});

			zone.addEventListener('dragleave', function() {
				this.classList.remove('drag-over');
			});

			zone.addEventListener('drop', async function(e) {
				e.preventDefault();
				this.classList.remove('drag-over');

				if (!draggingCard) return;
				const movedCard = draggingCard;
				const originalParent = movedCard.parentElement;

				const entryId = movedCard.dataset.entryId || e.dataTransfer.getData('text/plain');
				const targetDate = this.dataset.date;
				const targetMealType = this.dataset.mealType;

				if (!entryId || !targetDate || !targetMealType) {
					return;
				}

				try {
					const response = await fetch(`/meal-plan/move/${entryId}`, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
							'X-Requested-With': 'XMLHttpRequest'
						},
						body: JSON.stringify({
							date: targetDate,
							meal_type: targetMealType,
							week_offset: weekOffset
						})
					});

					const result = await response.json();
					if (!response.ok || !result.success) {
						throw new Error((result && result.error) || 'Failed to move meal');
					}

					if (originalParent && originalParent.classList.contains('meal-drop-zone')) {
						originalParent.classList.remove('drag-over');
					}
					this.appendChild(movedCard);
					movedCard.classList.remove('dragging');
					draggingCard = null;
					const mealLabel = mealTypeLabels[targetMealType] || targetMealType;
					const weekdayLabel = getWeekdayLabel(targetDate);
					const destinationLabel = weekdayLabel ? `${weekdayLabel} ${mealLabel}` : mealLabel;
					showPlannerSuccess(`Meal moved to ${destinationLabel}.`);
				} catch (err) {
					alert(err.message || 'Could not move meal. Please try again.');
				}
			});
		});
	}

	// Edit button click handler
	document.querySelectorAll('.edit-meal-btn').forEach(btn => {
		btn.addEventListener('click', function() {
			const entryId = this.dataset.entryId;
			const isMobile = this.dataset.mobile === 'true';
			const cardId = isMobile ? `meal-card-mobile-${entryId}` : `meal-card-${entryId}`;
			const card = document.getElementById(cardId);

			if (card) {
				card.classList.add('editing');
			}
		});
	});

	// Cancel button click handler
	document.querySelectorAll('.cancel-edit-btn').forEach(btn => {
		btn.addEventListener('click', function() {
			const entryId = this.dataset.entryId;
			const isMobile = this.dataset.mobile === 'true';
			const cardId = isMobile ? `meal-card-mobile-${entryId}` : `meal-card-${entryId}`;
			const card = document.getElementById(cardId);

			if (card) {
				card.classList.remove('editing');
			}
		});
	});

	// Add loading state to edit meal form save buttons
	document.querySelectorAll('.edit-meal-form').forEach(form => {
		form.addEventListener('submit', function(e) {
			const saveBtn = this.querySelector('button[type="submit"]');
			if (saveBtn) {
				saveBtn.disabled = true;
				saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Saving...';
			}
		});
	});
});

// Similar Recipes functionality
async function findSimilarRecipes() {
	const btn = document.getElementById('similar-recipes-btn');
	const modal = document.getElementById('similarRecipesModal');
	const weekOffset = {{ week_offset }};

	// Show modal with loading state
	modal.style.display = 'block';
	modal.classList.add('show');
	document.body.classList.add('modal-open');

	// Add backdrop
	let backdrop = document.querySelector('.modal-backdrop');
	if (!backdrop) {
		backdrop = document.createElement('div');
		backdrop.className = 'modal-backdrop fade show';
		document.body.appendChild(backdrop);
	}

	// Scroll to modal
	setTimeout(() => {
		modal.scrollIntoView({ behavior: 'smooth', block: 'center' });
	}, 100);

	document.getElementById('similar-recipes-loading').style.display = 'block';
	document.getElementById('similar-recipes-warning').style.display = 'none';
	document.getElementById('similar-recipes-empty').style.display = 'none';
	document.getElementById('similar-recipes-results').style.display = 'none';
	document.getElementById('apply-similar-recipes-btn').style.display = 'none';

	// Show loading state on button
	const originalBtnContent = btn.innerHTML;
	btn.disabled = true;
	btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Loading...';

	try {
		const formData = new FormData();
		formData.append('week_offset', weekOffset);

		const response = await fetch('{{ url_for("find_similar_recipes") }}', {
			method: 'POST',
			body: formData
		});

		const result = await response.json();

		// Hide loading
		document.getElementById('similar-recipes-loading').style.display = 'none';

		if (result.success && result.matched_recipes.length > 0) {
			// Show warning and results
			document.getElementById('similar-recipes-warning').style.display = 'block';
			document.getElementById('similar-recipes-results').style.display = 'block';
			document.getElementById('apply-similar-recipes-btn').style.display = 'inline-block';

			// Build accordion items
			const accordion = document.getElementById('similarRecipesAccordion');
			accordion.innerHTML = '';

			// Pass household users data to the function
			const householdUsers = [
				{% for user in household_users %}
				{ id: {{ user.id }}, name: "{{ user.username }}" },
				{% endfor %}
			];

			result.matched_recipes.forEach((recipe, index) => {
				const accordionItem = createRecipeAccordionItem(recipe, index, weekOffset, householdUsers);
				accordion.appendChild(accordionItem);
			});
		} else {
			// Show empty state
			document.getElementById('similar-recipes-empty').style.display = 'block';
		}

		// Restore button
		btn.disabled = false;
		btn.innerHTML = originalBtnContent;

	} catch (error) {
		console.error('Error finding similar recipes:', error);
		alert('Failed to find similar recipes. Please try again.');
		btn.disabled = false;
		btn.innerHTML = originalBtnContent;
		closeSimilarRecipesModal();
	}
}

function closeSimilarRecipesModal() {
	const modal = document.getElementById('similarRecipesModal');
	modal.style.display = 'none';
	modal.classList.remove('show');
	document.body.classList.remove('modal-open');

	const backdrop = document.querySelector('.modal-backdrop');
	if (backdrop) {
		backdrop.remove();
	}
}

function createRecipeAccordionItem(recipe, index, weekOffset, householdUsers) {
	const item = document.createElement('div');
	item.className = 'accordion-item';
	item.style.marginBottom = '1rem';
	item.style.border = '1px solid #dee2e6';
	item.style.borderRadius = '0.25rem';

	// Build household users options
	const userOptions = householdUsers.map(user =>
		`<option value="${user.id}">${user.name}</option>`
	).join('');

	// Build ingredients list with match indicators
	const ingredientsList = recipe.ingredients && recipe.ingredients.length > 0
		? `<div style="margin-bottom: 1rem; padding: 0.75rem; background: #f8f9fa; border-radius: 0.25rem;">
				<strong style="display: block; margin-bottom: 0.5rem;">Ingredients:</strong>
				<ul style="margin: 0; padding-left: 1.5rem; font-size: 0.9rem; list-style: none;">
					${recipe.ingredients.map(ing => {
						const icon = ing.matched
							? '<i class="fas fa-check-circle" style="color: #f97316; margin-right: 0.5rem;" title="Already on shopping list"></i>'
							: '<i class="far fa-circle" style="color: #6c757d; margin-right: 0.5rem;"></i>';
						const style = ing.matched ? 'color: #f97316; font-weight: 500;' : '';
						return `<li style="${style}">${icon}${ing.text}</li>`;
					}).join('')}
				</ul>
				<small style="color: #6c757d; display: block; margin-top: 0.5rem;">
					<i class="fas fa-check-circle" style="color: #f97316;"></i> = Already on your shopping list
				</small>
			</div>`
		: '';

	item.innerHTML = `
		<div class="accordion-header" id="heading${index}" style="background: #f8f9fa; border-bottom: 1px solid #dee2e6;">
			<div style="padding: 0.75rem 1rem; display: flex; align-items: center; cursor: pointer;" onclick="toggleRecipeAccordionHeader(${index})">
				<div style="margin-right: 1rem;" onclick="event.stopPropagation();">
					<input type="checkbox" class="recipe-checkbox" value="${recipe.id}"
						   id="recipe${recipe.id}" onchange="toggleRecipeAccordion(${index}, this.checked)"
						   style="width: 18px; height: 18px; cursor: pointer;">
				</div>
				<div style="flex-grow: 1;">
					<strong>${recipe.name}</strong>
					<span style="background: #f97316; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.875rem; margin-left: 0.5rem;">${recipe.match_percentage}% match</span>
					<small style="color: #6c757d; margin-left: 0.5rem;">(${recipe.ingredient_count} ingredients)</small>
				</div>
				<i class="fas fa-chevron-down" id="chevron${index}" style="transition: transform 0.3s;"></i>
			</div>
		</div>
		<div id="collapse${index}" style="display: none; padding: 1rem; background: white;">
			${ingredientsList}
			<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
				<div>
					<label for="date${recipe.id}" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Date</label>
					<input type="date" class="form-control recipe-date" id="date${recipe.id}" required style="width: 100%; padding: 0.5rem; border: 1px solid #ced4da; border-radius: 0.25rem;">
				</div>
				<div>
					<label for="meal_type${recipe.id}" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Meal Type</label>
					<select class="form-control recipe-meal-type" id="meal_type${recipe.id}" required style="width: 100%; padding: 0.5rem; border: 1px solid #ced4da; border-radius: 0.25rem;">
						<option value="">Select meal type...</option>
						<option value="breakfast">Breakfast</option>
						<option value="lunch">Lunch</option>
						<option value="dinner">Dinner</option>
					</select>
				</div>
				<div>
					<label for="cooks${recipe.id}" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Assigned Cooks (Optional)</label>
					<select class="form-control recipe-cooks" id="cooks${recipe.id}" multiple style="width: 100%; padding: 0.5rem; border: 1px solid #ced4da; border-radius: 0.25rem;">
						${userOptions}
					</select>
				</div>
				<div>
					<label for="notes${recipe.id}" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Notes (Optional)</label>
					<textarea class="form-control recipe-notes" id="notes${recipe.id}" rows="2" style="width: 100%; padding: 0.5rem; border: 1px solid #ced4da; border-radius: 0.25rem;"></textarea>
				</div>
			</div>
		</div>
	`;
	return item;
}

function toggleRecipeAccordionHeader(index) {
	const collapse = document.getElementById(`collapse${index}`);
	const chevron = document.getElementById(`chevron${index}`);

	if (collapse.style.display === 'none') {
		collapse.style.display = 'block';
		chevron.style.transform = 'rotate(180deg)';
	} else {
		collapse.style.display = 'none';
		chevron.style.transform = 'rotate(0deg)';
	}
}

function toggleRecipeAccordion(index, checked) {
	const collapse = document.getElementById(`collapse${index}`);
	const chevron = document.getElementById(`chevron${index}`);

	if (checked) {
		collapse.style.display = 'block';
		chevron.style.transform = 'rotate(180deg)';
	} else {
		collapse.style.display = 'none';
		chevron.style.transform = 'rotate(0deg)';
	}
}

async function applySimilarRecipes() {
	const checkboxes = document.querySelectorAll('.recipe-checkbox:checked');

	if (checkboxes.length === 0) {
		alert('Please select at least one recipe');
		return;
	}

	// Collect selected recipes with their details
	const selectedRecipes = [];
	let hasErrors = false;

	checkboxes.forEach(checkbox => {
		const recipeId = checkbox.value;
		const date = document.getElementById(`date${recipeId}`).value;
		const mealType = document.getElementById(`meal_type${recipeId}`).value;
		const cooksSelect = document.getElementById(`cooks${recipeId}`);
		const notes = document.getElementById(`notes${recipeId}`).value;

		if (!date || !mealType) {
			hasErrors = true;
			return;
		}

		const assignedCooks = Array.from(cooksSelect.selectedOptions).map(opt => opt.value);

		selectedRecipes.push({
			recipe_id: recipeId,
			date: date,
			meal_type: mealType,
			assigned_cooks: assignedCooks,
			notes: notes
		});
	});

	if (hasErrors) {
		alert('Please fill in Date and Meal Type for all selected recipes');
		return;
	}

	// Show loading state on apply button
	const applyBtn = document.getElementById('apply-similar-recipes-btn');
	const originalContent = applyBtn.innerHTML;
	applyBtn.disabled = true;
	applyBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Applying...';

	try {
		const response = await fetch('{{ url_for("apply_similar_recipes") }}', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
			},
			body: JSON.stringify({
				recipes: selectedRecipes,
				week_offset: {{ week_offset }}
			})
		});

		const result = await response.json();

		if (result.success) {
			// Reload the meal plan page to show the newly added recipes
			window.location.reload();
		} else {
			alert(result.error || 'Failed to apply recipes');
			applyBtn.disabled = false;
			applyBtn.innerHTML = originalContent;
		}
	} catch (error) {
		console.error('Error applying similar recipes:', error);
		alert('Failed to apply recipes. Please try again.');
		applyBtn.disabled = false;
		applyBtn.innerHTML = originalContent;
	}
}
</script>
{% endblock %}
