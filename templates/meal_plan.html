{% extends 'base.html' %}

{% block title %}Meal Plan - Auto Cart{% endblock %}

{% block content %}
<style>
	.meal-plan-table {
		border-collapse: separate;
		border-spacing: 0;
		border-radius: 0;
		overflow: hidden;
	}

	.meal-plan-table thead th {
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.5px;
		font-size: 0.7rem;
		padding: 10px 8px !important;
		background: #f97316 !important;
		border: none !important;
		color: white !important;
	}

	.meal-plan-table tbody tr {
		border-bottom: 1px solid #e5e7eb;
		transition: background-color 0.15s ease;
	}

	.meal-plan-table tbody tr:hover {
		background-color: #f9fafb;
	}

	.meal-plan-table tbody td {
		padding: 6px !important;
		vertical-align: top;
	}

	.meal-card {
		transition: all 0.15s ease;
		border-radius: 6px !important;
		border: 1px solid #e5e7eb !important;
		border-left: 2px solid #3b82f6 !important;
		margin-bottom: 6px !important;
	}

	.desktop-view .meal-card[draggable="true"] {
		cursor: grab;
	}

	.desktop-view .meal-card.dragging {
		opacity: 0.55;
		transform: scale(0.98);
	}

	.desktop-view .meal-drop-zone {
		transition: background-color 0.15s ease, outline-color 0.15s ease;
	}

	.desktop-view .meal-drop-zone.drag-over {
		background-color: #eff6ff !important;
		outline: 2px dashed #60a5fa;
		outline-offset: -2px;
	}

	.desktop-meal-actions {
		display: flex;
		gap: 4px;
		flex-shrink: 0;
		margin-left: 6px;
		align-items: center;
	}

	.desktop-meal-actions form {
		margin: 0;
		display: flex;
		align-items: center;
	}

	.desktop-action-btn {
		width: 22px;
		min-width: 22px;
		height: 22px;
		min-height: 22px !important;
		padding: 0 !important;
		display: flex !important;
		align-items: center;
		justify-content: center;
		line-height: 1 !important;
		font-size: 0.7rem !important;
		border-width: 1px !important;
		border-style: solid;
		border-radius: 4px !important;
		box-sizing: border-box;
		background: #ffffff;
		cursor: pointer;
		appearance: none;
		-webkit-appearance: none;
		transition: all 0.15s ease;
	}

	.desktop-action-btn-edit {
		border-color: #d1d5db;
		color: #6b7280;
	}

	.desktop-action-btn-delete {
		border-color: #fecaca;
		color: #dc2626;
	}

	.desktop-action-btn i {
		display: flex;
		align-items: center;
		justify-content: center;
		width: 1em;
		height: 1em;
		line-height: 1;
		pointer-events: none;
	}

	.meal-card:hover {
		transform: translateY(-1px);
		box-shadow: 0 2px 8px rgba(0,0,0,0.08) !important;
		border-left-color: #2563eb !important;
	}

	.meal-link {
		color: #1e40af;
		transition: color 0.15s ease;
	}

	.meal-link:hover {
		color: #1e3a8a !important;
		text-decoration: none !important;
	}

	/* Clickable day header cells */
	.clickable-day-header {
		transition: all 0.15s ease;
		position: relative;
	}

	.clickable-day-header:hover {
		background-color: #ea580c !important;
		transform: translateY(-1px);
	}

	.clickable-day-header:active {
		transform: translateY(0);
	}

	.day-name {
		font-size: 0.75rem;
		font-weight: 600;
		color: white;
		line-height: 1.2;
		text-transform: uppercase;
		letter-spacing: 0.3px;
	}

	.day-date {
		font-size: 0.7rem;
		color: rgba(255, 255, 255, 0.9);
		font-weight: 500;
		margin-top: 2px;
	}

	.add-meal-icon {
		position: absolute;
		top: 50%;
		right: 8px;
		transform: translateY(-50%);
		font-size: 1rem;
		color: white;
		opacity: 0.7;
		transition: opacity 0.15s ease;
	}

	.clickable-day:hover .add-meal-icon {
		opacity: 1;
	}

	/* Multi-select styling */
	#assigned_cook_ids {
		background-color: white;
		border: 1px solid #ced4da;
	}

	#assigned_cook_ids option {
		padding: 6px 8px;
		border-radius: 3px;
		margin: 2px 0;
	}

	#assigned_cook_ids option:checked {
		background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
		color: white;
		font-weight: 500;
	}

	/* Inline edit mode styling */
	.chef-display {
		display: block;
	}

	.chef-edit {
		display: none;
	}

	.meal-card.editing .chef-display {
		display: none;
	}

	.meal-card.editing .chef-edit {
		display: block;
	}

	.edit-cook-select {
		font-size: 0.75rem;
		padding: 2px 4px;
		min-height: 60px;
	}

	.edit-cook-select option:checked {
		background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
		color: white;
		font-weight: 500;
	}

	.mobile-meal-actions {
		display: flex;
		gap: 6px;
		flex-shrink: 0;
		margin-left: 6px;
		align-items: center;
	}

	.mobile-meal-actions form {
		margin: 0;
		display: flex;
		align-items: center;
	}

	.mobile-action-btn {
		width: 28px;
		min-width: 28px;
		height: 28px;
		min-height: 28px !important;
		min-width: 28px !important;
		padding: 0 !important;
		display: flex !important;
		align-items: center;
		justify-content: center;
		line-height: 1 !important;
		font-size: 0.75rem !important;
		border-width: 1px !important;
		border-style: solid;
		border-radius: 6px !important;
		box-sizing: border-box;
		background: #ffffff;
		cursor: pointer;
		appearance: none;
		-webkit-appearance: none;
	}

	.mobile-action-btn-edit {
		border-color: #93c5fd;
		color: #1d4ed8;
	}

	.mobile-action-btn-delete {
		border-color: #fecaca;
		color: #dc2626;
	}

	.mobile-action-btn i {
		display: flex;
		align-items: center;
		justify-content: center;
		width: 1em;
		height: 1em;
		line-height: 1;
		pointer-events: none;
		font-size: 0.8rem;
	}

	/* Mobile-specific styles */
	@media (max-width: 768px) {
		/* Hide table on mobile */
		.desktop-view {
			display: none;
		}

		/* Show mobile card view */
		.mobile-view {
			display: block;
		}

		/* Stack header items vertically */
		.meal-plan-header {
			flex-direction: column !important;
			gap: 0.5rem;
		}

		.meal-plan-header h4 {
			font-size: 1.1rem !important;
		}

		.meal-plan-header .btn-group {
			width: 100%;
		}

		.meal-plan-header .btn {
			font-size: 0.75rem !important;
			padding: 0.25rem 0.5rem !important;
		}

		/* Navigation buttons */
		.week-nav-buttons {
			flex-direction: column !important;
			width: 100%;
		}

		.week-nav-buttons .btn {
			width: 100%;
			margin-bottom: 0.5rem;
		}

		/* Mobile day cards */
		.mobile-day-card {
			margin-bottom: 1rem;
		}

		.mobile-meal-section {
			margin-bottom: 0.75rem;
		}

		.mobile-meal-type-header {
			font-size: 0.85rem;
			font-weight: 600;
			color: #0d6efd;
			margin-bottom: 0.5rem;
			text-transform: uppercase;
		}
	}

	/* Desktop-specific styles */
	@media (min-width: 769px) {
		.mobile-view {
			display: none;
		}

		.desktop-view {
			display: block;
		}
	}
</style>
<div class="container-fluid mt-4">
	<div id="meal-plan-notification-anchor" class="mb-4"></div>
	<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
		<h1 class="mb-2 mb-md-0"><i class="fas fa-calendar-alt"></i> Meal Plan</h1>
		<div class="week-nav-buttons d-flex gap-2">
			<a href="{{ url_for('meal_plan', week=week_offset-1) }}" class="btn btn-outline-primary btn-sm">
				<i class="fas fa-chevron-left"></i> <span class="d-none d-md-inline">Previous Week</span><span class="d-md-none">Prev</span>
			</a>
			<a href="{{ url_for('meal_plan', week=0) }}" class="btn btn-primary btn-sm">
				<i class="fas fa-calendar-day"></i> <span class="d-none d-md-inline">This Week</span><span class="d-md-none">Today</span>
			</a>
			<a href="{{ url_for('meal_plan', week=week_offset+1) }}" class="btn btn-outline-primary btn-sm">
				<span class="d-none d-md-inline">Next Week</span><span class="d-md-none">Next</span> <i class="fas fa-chevron-right"></i>
			</a>
		</div>
	</div>

	<div class="card shadow mb-4">
		<div class="card-header bg-primary text-white meal-plan-header d-flex justify-content-between align-items-center flex-wrap">
			<h4 class="mb-2 mb-md-0" style="color: white;">
				{{ week_start.strftime('%B %d') }} - {{ week_end.strftime('%B %d, %Y') }}
			</h4>
			<div class="d-flex gap-2">
				<form method="POST" action="{{ url_for('send_meal_plan_email') }}" id="email-meal-plan-form" style="display: inline;">
					<input type="hidden" name="week_offset" value="{{ week_offset }}">
					<button type="submit" id="email-meal-plan-btn" class="btn btn-light btn-sm">
						<i class="fas fa-envelope"></i> <span class="d-none d-md-inline">Email My Meals</span><span class="d-md-none">Email</span>
					</button>
				</form>
				<form method="POST" action="{{ url_for('add_meal_plan_to_list') }}" id="add-to-list-form" style="display: inline;">
					<input type="hidden" name="week_offset" value="{{ week_offset }}">
					<button type="submit" id="add-to-list-btn" class="btn btn-light btn-sm">
						<i class="fas fa-shopping-cart"></i> <span class="d-none d-md-inline">Add All to Grocery List</span><span class="d-md-none">Add All</span>
					</button>
				</form>
			</div>
		</div>
		<div class="card-body p-0">
			<!-- Desktop Table View -->
			<div class="table-responsive desktop-view">
				<table class="table mb-0 meal-plan-table" style="table-layout: fixed; width: 100%;">
					<thead>
						<tr>
							<th style="width: 10%;">Meal</th>
							{% for date, meals in meal_plan.items() %}
							<th style="width: 12.86%; cursor: pointer; position: relative;"
								class="clickable-day-header"
								data-date="{{ date.strftime('%Y-%m-%d') }}"
								title="Click to add a meal for this day">
								<div class="day-name">{{ date.strftime('%a') }}</div>
								<div class="day-date">{{ date.strftime('%b %d') }}</div>
								<i class="fas fa-plus add-meal-icon"></i>
							</th>
							{% endfor %}
						</tr>
					</thead>
					<tbody>
						{% for meal_type in ['breakfast', 'lunch', 'dinner'] %}
						<tr>
							<td class="clickable-meal-type" style="font-weight: 600; font-size: 0.8rem; color: #1f2937;">
								{% if meal_type == 'breakfast' %}üç≥ Breakfast{% endif %}
								{% if meal_type == 'lunch' %}ü•ó Lunch{% endif %}
								{% if meal_type == 'dinner' %}üçΩÔ∏è Dinner{% endif %}
							</td>
							{% for date, meals in meal_plan.items() %}
							<td class="meal-drop-zone"
								data-date="{{ date.strftime('%Y-%m-%d') }}"
								data-meal-type="{{ meal_type }}"
								style="background-color: #f9fafb; {% if not loop.last %}border-right: 1px solid #e5e7eb;{% endif %}">
								{% for entry in meals[meal_type] %}
								<div class="meal-card"
									id="meal-card-{{ entry.id }}"
									data-entry-id="{{ entry.id }}"
									draggable="true"
									style="background: white;">
									<div style="padding: 8px;">
										<!-- Recipe Title Row -->
										{% if entry.recipe and entry.recipe.url %}
										<div class="mb-1" style="font-size: 0.8rem; font-weight: 600; color: #111827; line-height: 1.3;">
											<a href="{{ entry.recipe.url }}" target="_blank" class="meal-link text-decoration-none" title="View recipe">
												{{ entry.meal_name }} <i class="fas fa-external-link-alt" style="font-size: 0.6rem; opacity: 0.5;"></i>
											</a>
										</div>
										{% else %}
										<div class="mb-1" style="font-size: 0.8rem; font-weight: 600; color: #1e40af; line-height: 1.3;">{{ entry.meal_name }}</div>
										{% endif %}

										<!-- Chef Display Mode (default) -->
										<div class="chef-display">
											<div class="d-flex justify-content-between align-items-start">
												<div class="flex-grow-1" style="min-width: 0;">
													{% if entry.assigned_cooks.count() > 0 %}
													<div style="font-size: 0.7rem; color: #6b7280; margin-bottom: 2px;">
														<i class="fas fa-utensils" style="width: 11px; opacity: 0.6; font-size: 0.65rem; margin-right: 4px;"></i>
														<span style="font-weight: 500;">
															{% for cook in entry.assigned_cooks %}{{ cook.username }}{% if not loop.last %}, {% endif %}{% endfor %}
														</span>
													</div>
													{% elif entry.assigned_cook %}
													<div style="font-size: 0.7rem; color: #6b7280; margin-bottom: 2px;">
														<i class="fas fa-utensils" style="width: 11px; opacity: 0.6; font-size: 0.65rem; margin-right: 4px;"></i>
														<span style="font-weight: 500;">{{ entry.assigned_cook.username }}</span>
													</div>
													{% endif %}
													{% if entry.notes %}
													<div style="font-size: 0.65rem; color: #059669; background-color: #d1fae5; padding: 2px 6px; border-radius: 3px; display: inline-block; margin-top: 2px;">
														<i class="fas fa-sticky-note" style="font-size: 0.6rem;"></i> {{ entry.notes }}
													</div>
													{% endif %}
												</div>
													<div class="desktop-meal-actions">
														<!-- Edit Button -->
														<button type="button" class="edit-meal-btn desktop-action-btn desktop-action-btn-edit" data-entry-id="{{ entry.id }}">
															<i class="fas fa-edit"></i>
														</button>
														<!-- Delete Button -->
														<form method="POST" action="{{ url_for('delete_meal_plan_entry', entry_id=entry.id) }}">
															<input type="hidden" name="week_offset" value="{{ week_offset }}">
															<button type="submit" class="desktop-action-btn desktop-action-btn-delete" onclick="return confirm('Remove this meal from the plan?');">
																<i class="fas fa-times"></i>
															</button>
														</form>
												</div>
											</div>
										</div>

										<!-- Chef Edit Mode (hidden by default) -->
										<div class="chef-edit">
											<form method="POST" action="{{ url_for('update_meal_plan_entry', entry_id=entry.id) }}" class="edit-meal-form">
												<input type="hidden" name="week_offset" value="{{ week_offset }}">
												<div class="mb-2">
													<label style="font-size: 0.75rem; font-weight: 600; margin-bottom: 2px;">Assigned Cooks:</label>
													<select name="assigned_cook_ids" class="form-control edit-cook-select" multiple>
														{% for user in household_users %}
														<option value="{{ user.id }}" {% if user in entry.assigned_cooks %}selected{% endif %}>
															{{ user.username }}
														</option>
														{% endfor %}
													</select>
													<small class="text-muted" style="font-size: 0.65rem;">Hold Ctrl/Cmd for multiple. Removed chefs will be emailed.</small>
												</div>
												<div class="d-flex gap-1">
													<button type="submit" class="btn btn-sm btn-success" style="font-size: 0.7rem; padding: 2px 8px;">
														<i class="fas fa-check"></i> Save
													</button>
													<button type="button" class="btn btn-sm btn-secondary cancel-edit-btn" data-entry-id="{{ entry.id }}" style="font-size: 0.7rem; padding: 2px 8px;">
														<i class="fas fa-times"></i> Cancel
													</button>
												</div>
											</form>
										</div>
									</div>
								</div>
								{% endfor %}
							</td>
							{% endfor %}
						</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>

		<!-- Mobile Card View -->
		<div class="mobile-view p-3">
			{% for date, meals in meal_plan.items() %}
			<div class="mobile-day-card card mb-3 {% if date == today %}border-info{% endif %}">
				<div class="card-header {% if date == today %}bg-info bg-opacity-10{% else %}bg-light{% endif %} clickable-day"
					style="cursor: pointer;"
					data-date="{{ date.strftime('%Y-%m-%d') }}"
					title="Click to add a meal for this day">
					<div class="d-flex justify-content-between align-items-center">
						<div>
							<span class="fw-bold" style="font-size: 1rem;">{{ date.strftime('%A') }}</span>
							<span class="text-muted ms-2" style="font-size: 0.85rem; font-weight: 500;">{{ date.strftime('%b %d') }}</span>
						</div>
						<i class="fas fa-plus-circle text-success" style="font-size: 1.2rem;"></i>
					</div>
				</div>
				<div class="card-body">
					{% for meal_type in ['breakfast', 'lunch', 'dinner'] %}
					{% if meals[meal_type] %}
					<div class="mobile-meal-section">
						<div class="mobile-meal-type-header">
							{{ meal_type|capitalize }}
						</div>
						{% for entry in meals[meal_type] %}
						<div class="card mb-2 border-0 shadow-sm meal-card" id="meal-card-mobile-{{ entry.id }}" style="border-left: 3px solid #0d6efd !important;">
							<div class="card-body p-2">
								<!-- Recipe Title Row -->
								{% if entry.recipe and entry.recipe.url %}
								<div class="fw-bold mb-2" style="font-size: 0.95rem; overflow-x: auto; white-space: nowrap;">
									<a href="{{ entry.recipe.url }}" target="_blank" class="text-primary text-decoration-none meal-link" title="View recipe at {{ entry.recipe.url }}">
										{{ entry.meal_name }} <i class="fas fa-external-link-alt" style="font-size: 0.7rem;"></i>
									</a>
								</div>
								{% else %}
								<div class="fw-bold text-primary mb-2" style="font-size: 0.95rem; overflow-x: auto; white-space: nowrap;">{{ entry.meal_name }}</div>
								{% endif %}

								<!-- Chef Display Mode (default) -->
								<div class="chef-display">
									<div class="d-flex justify-content-between align-items-center">
										<div class="flex-grow-1">
											{% if entry.assigned_cooks.count() > 0 %}
											<span class="text-muted" style="font-size: 0.8rem;">
												<i class="fas fa-utensils"></i>
												{% for cook in entry.assigned_cooks %}{{ cook.username }}{% if not loop.last %}, {% endif %}{% endfor %}
											</span>
											{% elif entry.assigned_cook %}
											<span class="text-muted" style="font-size: 0.8rem; white-space: nowrap;"><i class="fas fa-utensils"></i> {{ entry.assigned_cook.username }}</span>
											{% endif %}
											{% if entry.notes %}
											<div class="text-info" style="font-size: 0.75rem;"><i class="fas fa-sticky-note"></i> {{ entry.notes }}</div>
											{% endif %}
										</div>
										<div class="mobile-meal-actions">
											<!-- Edit Button -->
											<button type="button" class="edit-meal-btn mobile-action-btn mobile-action-btn-edit" data-entry-id="{{ entry.id }}" data-mobile="true">
												<i class="fas fa-edit"></i>
											</button>
											<!-- Delete Button -->
												<form method="POST" action="{{ url_for('delete_meal_plan_entry', entry_id=entry.id) }}">
													<input type="hidden" name="week_offset" value="{{ week_offset }}">
														<button type="submit" class="mobile-action-btn mobile-action-btn-delete" onclick="return confirm('Remove this meal from the plan?');">
															<i class="fas fa-times"></i>
														</button>
												</form>
										</div>
									</div>
								</div>

								<!-- Chef Edit Mode (hidden by default) -->
								<div class="chef-edit">
									<form method="POST" action="{{ url_for('update_meal_plan_entry', entry_id=entry.id) }}" class="edit-meal-form">
										<input type="hidden" name="week_offset" value="{{ week_offset }}">
										<div class="mb-2 d-md-none">
											<label style="font-size: 0.75rem; font-weight: 600; margin-bottom: 2px;">Date:</label>
											<input type="date" name="date" class="form-control form-control-sm" value="{{ entry.date.strftime('%Y-%m-%d') }}">
										</div>
										<div class="mb-2">
											<label style="font-size: 0.75rem; font-weight: 600; margin-bottom: 2px;">Assigned Cooks:</label>
											<select name="assigned_cook_ids" class="form-control edit-cook-select" multiple>
												{% for user in household_users %}
												<option value="{{ user.id }}" {% if user in entry.assigned_cooks %}selected{% endif %}>
													{{ user.username }}
												</option>
												{% endfor %}
											</select>
											<small class="text-muted" style="font-size: 0.65rem;">Hold Ctrl/Cmd for multiple. Removed chefs will be emailed.</small>
										</div>
										<div class="d-flex gap-1">
											<button type="submit" class="btn btn-sm btn-success" style="font-size: 0.7rem; padding: 2px 8px;">
												<i class="fas fa-check"></i> Save
											</button>
											<button type="button" class="btn btn-sm btn-secondary cancel-edit-btn" data-entry-id="{{ entry.id }}" data-mobile="true" style="font-size: 0.7rem; padding: 2px 8px;">
												<i class="fas fa-times"></i> Cancel
											</button>
										</div>
									</form>
								</div>
							</div>
						</div>
						{% endfor %}
					</div>
					{% endif %}
					{% endfor %}

					{% if not meals['breakfast'] and not meals['lunch'] and not meals['dinner'] %}
					<div class="text-muted text-center py-2" style="font-size: 0.85rem;">
						<i class="fas fa-calendar-times"></i> No meals planned
					</div>
					{% endif %}
				</div>
			</div>
			{% endfor %}
		</div>
	</div>
</div>

	<!-- Add Meal Form -->
	<div class="card shadow">
		<div class="card-header bg-success text-white">
			<h5 class="mb-0"><i class="fas fa-plus"></i> Add Meal to Plan</h5>
		</div>
		<div class="card-body">
			<form method="POST" action="{{ url_for('add_meal_plan_entry') }}" id="addMealForm">
				<input type="hidden" name="week_offset" value="{{ week_offset }}">
				<div class="row g-3">
					<div class="col-md-6 col-lg-4">
						<label for="recipe_id" class="form-label" style="font-size: 0.85rem;"><strong>Recipe</strong></label>
						<select name="recipe_id" id="recipe_id" class="form-control w-100" style="font-size: 0.9rem; padding: 0.4rem 0.6rem;" onchange="toggleCustomMeal()">
							<option value="">Select a recipe...</option>
							{% for recipe in recipes %}
							<option value="{{ recipe.id }}">{{ recipe.name }}</option>
							{% endfor %}
							<option value="custom">‚ûï Add Your Own</option>
						</select>
					</div>
					<div class="col-md-6 col-lg-4" id="customMealDiv" style="display: none;">
						<label for="custom_meal_name" class="form-label" style="font-size: 0.85rem;"><strong>Name</strong></label>
						<input type="text" name="custom_meal_name" id="custom_meal_name" class="form-control w-100" style="font-size: 0.9rem; padding: 0.4rem 0.6rem;" placeholder="e.g., Pizza Night">
					</div>
					<div class="col-md-6 col-lg-4">
						<label for="date" class="form-label" style="font-size: 0.85rem;"><strong>Date</strong></label>
						<input type="date" name="date" id="date" class="form-control w-100" style="font-size: 0.9rem; padding: 0.4rem 0.6rem;" required>
					</div>
					<div class="col-md-6 col-lg-4">
						<label for="meal_type" class="form-label" style="font-size: 0.85rem;"><strong>Meal</strong></label>
						<select name="meal_type" id="meal_type" class="form-control w-100" style="font-size: 0.9rem; padding: 0.4rem 0.6rem;" required>
							<option value="" disabled selected>Select...</option>
							<option value="breakfast">Breakfast</option>
							<option value="lunch">Lunch</option>
							<option value="dinner">Dinner</option>
						</select>
					</div>
					<div class="col-md-6 col-lg-4">
						<label for="assigned_cook_ids" class="form-label" style="font-size: 0.85rem;"><strong>Cooks</strong> <small class="text-muted">(hold Ctrl/Cmd to select multiple)</small></label>
						<select name="assigned_cook_ids" id="assigned_cook_ids" class="form-control w-100" style="font-size: 0.9rem; padding: 0.4rem 0.6rem; min-height: 80px;" multiple>
							{% for user in household_users %}
							<option value="{{ user.id }}">{{ user.username }}</option>
							{% endfor %}
						</select>
					</div>
					<div class="col-md-6 col-lg-4">
						<label for="notes" class="form-label" style="font-size: 0.85rem;"><strong>Notes</strong></label>
						<input type="text" name="notes" id="notes" class="form-control w-100" style="font-size: 0.9rem; padding: 0.4rem 0.6rem;" placeholder="Optional">
					</div>
					<div class="col-12">
						<button type="submit" id="add-meal-btn" class="btn btn-success w-100" style="font-size: 0.9rem; padding: 0.5rem;">
							<i class="fas fa-plus"></i> Add Meal to Plan
						</button>
					</div>
				</div>
			</form>
		</div>
	</div>
</div>

<script>
// Set default date to today
document.getElementById('date').valueAsDate = new Date();

// Toggle custom meal name field
function toggleCustomMeal() {
	const recipeSelect = document.getElementById('recipe_id');
	const customMealDiv = document.getElementById('customMealDiv');
	const customMealInput = document.getElementById('custom_meal_name');

	if (recipeSelect.value === 'custom') {
		customMealDiv.style.display = 'block';
		customMealInput.required = true;
	} else {
		customMealDiv.style.display = 'none';
		customMealInput.required = false;
		customMealInput.value = '';
	}
}

// Handle clicking on day header cells to add meals
document.addEventListener('DOMContentLoaded', function() {
	const clickableDayHeaders = document.querySelectorAll('.clickable-day-header');
	const dateInput = document.getElementById('date');
	const addMealForm = document.getElementById('addMealForm');

	clickableDayHeaders.forEach(function(dayHeader) {
		dayHeader.addEventListener('click', function(e) {
			const selectedDate = this.getAttribute('data-date');

			// Set the date in the form
			dateInput.value = selectedDate;

			// Scroll to the form smoothly
			addMealForm.scrollIntoView({ behavior: 'smooth', block: 'center' });

			// Add a brief highlight effect to the form
			addMealForm.style.transition = 'box-shadow 0.3s ease';
			addMealForm.style.boxShadow = '0 0 20px rgba(13, 110, 253, 0.5)';
			setTimeout(function() {
				addMealForm.style.boxShadow = '';
			}, 1500);

			// Focus on the recipe select field
			setTimeout(function() {
				document.getElementById('recipe_id').focus();
			}, 500);
		});
	});
});

// Form validation and processing state for Add Meal form
const addMealForm = document.getElementById('addMealForm');
const addMealBtn = document.getElementById('add-meal-btn');

addMealForm.addEventListener('submit', function(e) {
	const recipeSelect = document.getElementById('recipe_id');
	const customMealInput = document.getElementById('custom_meal_name');

	if (recipeSelect.value === 'custom' && !customMealInput.value.trim()) {
		e.preventDefault();
		alert('Please enter a custom meal name');
		customMealInput.focus();
		return false;
	}

	if (!recipeSelect.value) {
		e.preventDefault();
		alert('Please select a recipe or choose "Add Your Own"');
		recipeSelect.focus();
		return false;
	}

	// Add processing state
	addMealBtn.disabled = true;
	addMealBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Adding...';
});

// Add processing state to Email My Meals button
const emailMealPlanForm = document.getElementById('email-meal-plan-form');
const emailMealPlanBtn = document.getElementById('email-meal-plan-btn');

if (emailMealPlanForm && emailMealPlanBtn) {
	emailMealPlanForm.addEventListener('submit', function() {
		emailMealPlanBtn.disabled = true;
		emailMealPlanBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Sending...';
	});
}

// Add processing state to Add All to Grocery List button
const addToListForm = document.getElementById('add-to-list-form');
const addToListBtn = document.getElementById('add-to-list-btn');

if (addToListForm && addToListBtn) {
	addToListForm.addEventListener('submit', function() {
		addToListBtn.disabled = true;
		addToListBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Adding...';
	});
}

// Inline edit functionality for meal cards
document.addEventListener('DOMContentLoaded', function() {
	const isDesktop = window.matchMedia('(min-width: 769px)').matches;
	const weekOffset = {{ week_offset|tojson }};
	const mealTypeLabels = {
		breakfast: 'Breakfast',
		lunch: 'Lunch',
		dinner: 'Dinner'
	};

	function showPlannerSuccess(message) {
		const notificationAnchor = document.getElementById('meal-plan-notification-anchor');
		if (!notificationAnchor) return;

		notificationAnchor.innerHTML = '';

		const flashDiv = document.createElement('div');
		flashDiv.className = 'alert alert-success';
		flashDiv.setAttribute('role', 'alert');
		flashDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
		notificationAnchor.appendChild(flashDiv);
		setTimeout(() => flashDiv.remove(), 5000);
	}

	function getWeekdayLabel(dateIso) {
		if (!dateIso) return '';
		const parts = dateIso.split('-');
		if (parts.length !== 3) return '';
		const year = parseInt(parts[0], 10);
		const month = parseInt(parts[1], 10) - 1;
		const day = parseInt(parts[2], 10);
		const dateObj = new Date(year, month, day);
		if (Number.isNaN(dateObj.getTime())) return '';
		return dateObj.toLocaleDateString(undefined, { weekday: 'long' });
	}

	function clearDropHighlights() {
		document.querySelectorAll('.meal-drop-zone.drag-over').forEach(zone => {
			zone.classList.remove('drag-over');
		});
	}

	if (isDesktop) {
		let draggingCard = null;

		document.querySelectorAll('.desktop-view .meal-card[draggable="true"]').forEach(card => {
			card.addEventListener('dragstart', function(e) {
				if (this.classList.contains('editing')) {
					e.preventDefault();
					return;
				}
				draggingCard = this;
				this.classList.add('dragging');
				e.dataTransfer.effectAllowed = 'move';
				e.dataTransfer.setData('text/plain', this.dataset.entryId || '');
			});

			card.addEventListener('dragend', function() {
				this.classList.remove('dragging');
				draggingCard = null;
				clearDropHighlights();
			});
		});

		document.querySelectorAll('.desktop-view .meal-drop-zone').forEach(zone => {
			zone.addEventListener('dragover', function(e) {
				if (!draggingCard) return;
				e.preventDefault();
				e.dataTransfer.dropEffect = 'move';
				this.classList.add('drag-over');
			});

			zone.addEventListener('dragleave', function() {
				this.classList.remove('drag-over');
			});

			zone.addEventListener('drop', async function(e) {
				e.preventDefault();
				this.classList.remove('drag-over');

				if (!draggingCard) return;
				const movedCard = draggingCard;
				const originalParent = movedCard.parentElement;

				const entryId = movedCard.dataset.entryId || e.dataTransfer.getData('text/plain');
				const targetDate = this.dataset.date;
				const targetMealType = this.dataset.mealType;

				if (!entryId || !targetDate || !targetMealType) {
					return;
				}

				try {
					const response = await fetch(`/meal-plan/move/${entryId}`, {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
							'X-Requested-With': 'XMLHttpRequest'
						},
						body: JSON.stringify({
							date: targetDate,
							meal_type: targetMealType,
							week_offset: weekOffset
						})
					});

					const result = await response.json();
					if (!response.ok || !result.success) {
						throw new Error((result && result.error) || 'Failed to move meal');
					}

					if (originalParent && originalParent.classList.contains('meal-drop-zone')) {
						originalParent.classList.remove('drag-over');
					}
					this.appendChild(movedCard);
					movedCard.classList.remove('dragging');
					draggingCard = null;
					const mealLabel = mealTypeLabels[targetMealType] || targetMealType;
					const weekdayLabel = getWeekdayLabel(targetDate);
					const destinationLabel = weekdayLabel ? `${weekdayLabel} ${mealLabel}` : mealLabel;
					showPlannerSuccess(`Meal moved to ${destinationLabel}.`);
				} catch (err) {
					alert(err.message || 'Could not move meal. Please try again.');
				}
			});
		});
	}

	// Edit button click handler
	document.querySelectorAll('.edit-meal-btn').forEach(btn => {
		btn.addEventListener('click', function() {
			const entryId = this.dataset.entryId;
			const isMobile = this.dataset.mobile === 'true';
			const cardId = isMobile ? `meal-card-mobile-${entryId}` : `meal-card-${entryId}`;
			const card = document.getElementById(cardId);

			if (card) {
				card.classList.add('editing');
			}
		});
	});

	// Cancel button click handler
	document.querySelectorAll('.cancel-edit-btn').forEach(btn => {
		btn.addEventListener('click', function() {
			const entryId = this.dataset.entryId;
			const isMobile = this.dataset.mobile === 'true';
			const cardId = isMobile ? `meal-card-mobile-${entryId}` : `meal-card-${entryId}`;
			const card = document.getElementById(cardId);

			if (card) {
				card.classList.remove('editing');
			}
		});
	});
});
</script>
{% endblock %}
