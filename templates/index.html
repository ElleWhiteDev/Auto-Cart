{% extends 'base.html' %} {% block body_class %}Homepage{% endblock %} {% block
content %}
<div class="container">
	<div class="row justify-content-center">
		<div class="col-12">
			<h1 class="text-center">Welcome to Auto Cart</h1>
		</div>
		<div class="col-8">
			<p class="text-center">
				Auto Cart is a web application that allows you to create a grocery list
				based on the recipes you want to make. Simply add your recipes, select
				the ones you want to make, and we'll generate a grocery list for you!
			</p>
		</div>
	</div>
<div class="btn-container">
    <div class="row justify-content-center">
        <div class="col-6">
            <a class="button-56" href="#email-modal" id="modal-closed">Email List</a>
        </div>
        <div class="col-6">
            <button type="button" onclick="openKrogerAuth()" class="button-56">Add to Cart</button>
        </div>
    </div>
</div>
	<div class="container">
		<div class="row justify-content-center">
			<!-- Current Recipes Column -->
			<div class="col-4 sidebar border">
				<form method="POST" action="{{ url_for('update_grocery_list') }}">
					<h3>Recipe Box</h3>
					{% for recipe in recipes %}
					<div>
						<input
							type="checkbox"
							name="recipe_ids"
							value="{{ recipe.id }}"
							{%
							if
							recipe.id|string
							in
							selected_recipe_ids
							%}checked{%
							endif
							%}
						/>
						{{ recipe.name }}
					</div>
					{% endfor %}
					<button type="submit" class="button-54-smaller">
						Update Grocery List
					</button>
				</form>
			</div>

			<!-- New Recipe Form Column -->
			<div class="col-4">
				<h3>Add New Recipe</h3>
				<form method="POST" action="{{ url_for('add_recipe') }}" id="user_form">
					{{ form.hidden_tag() }}

					<!-- Recipe Name -->
					<p>
						{{ form.name.label }}
						{{ form.name(class_="form-control custom-form-control") }}
						{% for error in form.name.errors %}
						<span class="form-text text-danger"> {{ error }} </span>
						{% endfor %}
					</p>

					<!-- URL field with AI extract button -->
					<div class="form-group">
						{{ form.url.label(class="form-label") }}
						<div class="input-group">
							{{ form.url(class="form-control") }}
							<button type="button" id="extract-ai-btn" class="btn btn-outline-secondary">
								<span id="extract-spinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
								Extract with AI
							</button>
						</div>
					</div>

					<!-- Ingredients -->
					<p>
						{{ form.ingredients_text.label }}
						{{ form.ingredients_text(class_="form-control custom-form-control") }}
						{% for error in form.ingredients_text.errors %}
						<span class="form-text text-danger"> {{ error }} </span>
						{% endfor %}
					</p>

					<!-- Standardize button -->
					<div class="form-group">
						<button type="button" id="standardize-btn" class="btn btn-outline-primary btn-sm">
							<span id="standardize-spinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
							Standardize Ingredients
						</button>
					</div>

					<!-- Notes -->
					<p>
						{{ form.notes.label }}
						{{ form.notes(class_="form-control custom-form-control") }}
						{% for error in form.notes.errors %}
						<span class="form-text text-danger"> {{ error }} </span>
						{% endfor %}
					</p>

					<button type="submit" class="btn-submit">Submit</button>
				</form>
			</div>

			<!-- Grocery List Column -->
			<div class="col-4 grocery-list border">
				<div class="grocery-list-content">
					<div class="d-flex justify-content-between align-items-center mb-3">
						<h3>Your Grocery List</h3>
						<form method="POST" action="{{ url_for('clear_grocery_list') }}" style="display: inline;">
							<button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to clear your grocery list?')">Clear List</button>
						</form>
					</div>
					<ul>
						{% for ingredient in g.grocery_list.recipe_ingredients %}
						<li>
							{{ ingredient.quantity}} {{ ingredient.measurement }} {{
							ingredient.ingredient_name }}
						</li>
						{% endfor %}
					</ul>
				</div>

				<!-- Manual ingredient input - justified to bottom -->
				<div class="manual-ingredient-input">
					<h5>Add Ingredient</h5>
					<form method="POST" action="{{ url_for('add_manual_ingredient') }}">
						<div class="input-group mb-2">
							<input type="text" name="ingredient_text" class="form-control form-control-sm"
								   placeholder="e.g., 2 cups flour" required>
							<button type="submit" class="btn btn-sm btn-primary">Add</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>


<!-- Zipcode Modal -->
	<div class="modal-container" id="modal-zipcode">
		<div class="my-modal">
			<div class="details">
				<h1 class="title">Location Select</h1>
				<p class="description">
					Please enter your zipcode to find the nearest Kroger store
				</p>
			</div>
			<form
				method="POST"
				action="{{ url_for('location_search') }}"
				id="user_form"
			>
				<input type="text" name="zipcode" placeholder="Enter Zipcode" />
				<button type="submit">Next</button>
			</form>
			<p><a href="#modal-closed" class="btn">Cancel</a></p>
		</div>
	</div>

	<!-- Store Selection Modal -->
	<div class="modal-container" id="modal-store">
		<div class="my-modal">
			<div class="details">
				<h1 class="title">Store Select</h1>
				<p class="description">Please select the store you'd like to shop at</p>
			</div>
			<form method="POST" action="{{ url_for('select_store') }}" id="user_form">
				{% for address, city, location_id in session['stores'] %}
				<input type="radio" name="store_id" value="{{ location_id }}" />{{
				address }} {{ city }} {% endfor %}
				<button type="submit">Next</button>
			</form>
			<p>
				<a href="#modal-zipcode" class="btn">&larr; Previous</a>
				<a href="#modal-closed" class="btn">Cancel</a>
			</p>
		</div>
	</div>

	<!-- Ingredient Selection Modal -->
	<div class="modal-container" id="modal-ingredient">
		<div class="my-modal">
			<div class="details">
				<h1 class="title">Ingredient Select</h1>
				{% if session['current_ingredient_detail'] %}
				<p class="description">
					<strong>Looking for: {{ session['current_ingredient_detail']['quantity'] }} {{ session['current_ingredient_detail']['measurement'] }} {{ session['current_ingredient_detail']['name'] }}</strong><br>
					Please select the item you'd like to add to your cart
				</p>
				{% else %}
				<p class="description">
					Please select the item you'd like to add to your cart
				</p>
				{% endif %}
			</div>
			<form method="POST" action="{{ url_for('item_choice') }}" id="user_form">
				{% for item in session['items_to_choose_from'] %}
				<input type="radio" name="product_id" value="{{ item['id'] }}" />
				{{ item['name'] }} - ${{ item['price'] }} {% endfor %}
				<button type="submit">Next</button>
			</form>
			<form method="POST" action="{{ url_for('skip_ingredient') }}" style="display: inline;">
				<button type="submit" class="btn btn-outline-secondary">Skip</button>
			</form>
			<p>
				<a href="#modal-store" class="btn">&larr; Previous</a>
				<a href="#modal-closed" class="btn">Cancel</a>
			</p>
		</div>
	</div>

	<!-- Email Modal -->
<div id="email-modal" class="modal-container">
    <div class="my-modal">
        <div class="details">
            <h1 class="title">Email Grocery List</h1>
            <p class="description">Enter your email address to receive your grocery list</p>
        </div>
        <form action="/send-email" method="post">
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" required>
            <button type="submit" class="button-56">Send Email</button>
        </form>
        <p><a href="#modal-closed" class="btn">Cancel</a></p>
    </div>
</div>
</div>
{% endblock %}

{% block scripts %}
<script>
function openKrogerAuth() {
    // Navigate in the same tab instead of opening popup
    window.location.href = '/authenticate';
}

document.getElementById('extract-ai-btn').addEventListener('click', async function() {
    const urlInput = document.getElementById('url');

    if (!urlInput) {
        alert('Could not find URL input field');
        return;
    }

    const url = urlInput.value.trim();

    if (!url) {
        alert('Please enter a recipe URL first');
        return;
    }

    // Show loading state
    const btn = this;
    const spinner = document.getElementById('extract-spinner');
    const originalText = btn.innerHTML;

    btn.disabled = true;
    spinner.classList.remove('d-none');
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Extracting...';

    try {
        // Create form data and submit
        const formData = new FormData();
        formData.append('url', url);

        const response = await fetch('/extract-recipe-form', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            const result = await response.json();

            if (result.success) {
                // Populate form fields with extracted data
                const nameField = document.getElementById('name');
                const ingredientsField = document.getElementById('ingredients_text');
                const notesField = document.getElementById('notes');

                if (nameField && result.data.name) {
                    nameField.value = result.data.name;
                }

                if (ingredientsField && result.data.ingredients_text) {
                    ingredientsField.value = result.data.ingredients_text;
                }

                if (notesField && result.data.notes) {
                    notesField.value = result.data.notes;
                }

                showFlashMessage('Recipe extracted successfully! Review and edit as needed.', 'success');
            } else {
                showFlashMessage(result.error || 'Failed to extract recipe', 'danger');
            }
        } else {
            const errorResult = await response.json();
            showFlashMessage(errorResult.error || 'Failed to extract recipe', 'danger');
        }
    } catch (error) {
        showFlashMessage('Network error. Please try again.', 'danger');
    } finally {
        // Reset button state
        btn.disabled = false;
        spinner.classList.add('d-none');
        btn.innerHTML = originalText;
    }
});

function showFlashMessage(message, category) {
    // Create flash message element
    const flashDiv = document.createElement('div');
    flashDiv.className = `alert alert-${category} alert-dismissible fade show`;
    flashDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    // Insert at top of form
    const form = document.querySelector('#user_form');
    form.insertBefore(flashDiv, form.firstChild);

    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        flashDiv.remove();
    }, 5000);
}

// Email modal close functionality
document.addEventListener('DOMContentLoaded', function() {
    const emailModal = document.getElementById('email-modal');
    const closeBtn = emailModal.querySelector('.close');

    // Close modal when clicking the X
    if (closeBtn) {
        closeBtn.addEventListener('click', function() {
            emailModal.style.display = 'none';
        });
    }

    // Close modal when clicking outside of it
    window.addEventListener('click', function(event) {
        if (event.target === emailModal) {
            emailModal.style.display = 'none';
        }
    });
});

// Standardize ingredients functionality
document.getElementById('standardize-btn').addEventListener('click', async function() {
    const ingredientsField = document.getElementById('ingredients_text');

    if (!ingredientsField) {
        alert('Could not find ingredients field');
        return;
    }

    const ingredientsText = ingredientsField.value.trim();

    if (!ingredientsText) {
        alert('Please enter some ingredients first');
        return;
    }

    // Show loading state
    const btn = this;
    const spinner = document.getElementById('standardize-spinner');
    const originalText = btn.innerHTML;

    btn.disabled = true;
    spinner.classList.remove('d-none');
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Standardizing...';

    try {
        // Create form data and submit
        const formData = new FormData();
        formData.append('ingredients_text', ingredientsText);

        const response = await fetch('/standardize-ingredients', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            const result = await response.json();

            if (result.success) {
                // Update the ingredients field with standardized text
                ingredientsField.value = result.data.standardized_ingredients;
                showFlashMessage('Ingredients standardized successfully!', 'success');
            } else {
                showFlashMessage(result.error || 'Failed to standardize ingredients', 'danger');
            }
        } else {
            const errorResult = await response.json();
            showFlashMessage(errorResult.error || 'Failed to standardize ingredients', 'danger');
        }
    } catch (error) {
        showFlashMessage('Network error. Please try again.', 'danger');
    } finally {
        // Reset button state
        btn.disabled = false;
        spinner.classList.add('d-none');
        btn.innerHTML = originalText;
    }
});
</script>
{% endblock %}
