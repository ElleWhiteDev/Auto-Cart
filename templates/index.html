{% extends 'base.html' %} {% block body_class %}Homepage{% endblock %} {% block
content %}
<div class="container">
	<div class="row justify-content-center">
		<div class="col-12">
			<h1 class="text-center">Welcome to Auto Cart</h1>
		</div>
		<div class="col-8">
			<p class="text-center">
				Auto Cart is a web application that allows you to create a grocery list
				based on the recipes you want to make. Simply add your recipes, select
				the ones you want to make, and we'll generate a grocery list for you!
			</p>
		</div>
	</div>
	<div class="container">
		<div class="row justify-content-center">
			<!-- Current Recipes Column -->
			<div class="col-4 sidebar border">
				<form method="POST" action="{{ url_for('update_grocery_list') }}">
					<h3>Recipe Box</h3>
					{% for recipe in recipes %}
					<div>
						<input
							type="checkbox"
							name="recipe_ids"
							value="{{ recipe.id }}"
							{%
							if
							recipe.id|string
							in
							selected_recipe_ids
							%}checked{%
							endif
							%}
						/>
						{{ recipe.name }}
					</div>
					{% endfor %}
					<button type="submit" class="button-54-smaller">
						Update Grocery List
					</button>
				</form>
			</div>

			<!-- New Recipe Form Column -->
			<div class="col-4">
				<h3>Add New Recipe</h3>
				<form method="POST" action="{{ url_for('add_recipe') }}" id="user_form">
					{{ form.hidden_tag() }}

					<!-- Recipe Name -->
					<p>
						{{ form.name.label }}
						{{ form.name(class_="form-control custom-form-control") }}
						{% for error in form.name.errors %}
						<span class="form-text text-danger"> {{ error }} </span>
						{% endfor %}
					</p>

					<!-- URL field with AI extract button -->
					<div class="form-group">
						{{ form.url.label(class="form-label") }}
						{{ form.url(class="form-control") }}
						<div class="text-center mt-2">
							<button type="button" id="extract-ai-btn" class="btn btn-outline-secondary">
								<span id="extract-spinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
								Extract with AI
							</button>
						</div>
					</div>

					<!-- Ingredients -->
					<p>
						{{ form.ingredients_text.label }}
						{{ form.ingredients_text(class_="form-control custom-form-control") }}
						{% for error in form.ingredients_text.errors %}
						<span class="form-text text-danger"> {{ error }} </span>
						{% endfor %}
					</p>

					<!-- Standardize button -->
					<div class="form-group">
						<button type="button" id="standardize-btn" class="btn btn-outline-primary btn-sm">
							<span id="standardize-spinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
							Standardize Ingredients
						</button>
					</div>

					<!-- Notes -->
					<p>
						{{ form.notes.label }}
						{{ form.notes(class_="form-control custom-form-control") }}
						{% for error in form.notes.errors %}
						<span class="form-text text-danger"> {{ error }} </span>
						{% endfor %}
					</p>

					<button type="submit" class="btn-submit">Submit</button>
				</form>
			</div>

			<!-- Grocery List Column -->
			<div class="col-4 grocery-list border">
				<div class="grocery-list-content">
					<div class="d-flex justify-content-between align-items-center mb-3">
						<h3>Your Grocery List</h3>
						<form method="POST" action="{{ url_for('clear_grocery_list') }}" style="display: inline;">
							<button type="submit" class="btn btn-sm btn-outline-danger">Clear List</button>
						</form>
					</div>

					<!-- Email List and Add to Cart buttons -->
					<div class="btn-container mb-3">
						<div class="row">
							<div class="col-6">
								<a class="button-56" href="#email-modal" id="modal-closed">Email List</a>
							</div>
							<div class="col-6">
								<button type="button" onclick="openKrogerAuth()" class="button-56">Add to Cart</button>
							</div>
						</div>
					</div>

					<ul>
						{% for ingredient in g.grocery_list.recipe_ingredients %}
						<li class="d-flex justify-content-between align-items-center">
							<span>{{ ingredient.quantity}} {{ ingredient.measurement }} {{ ingredient.ingredient_name }}</span>
							<button type="button" class="btn btn-sm btn-outline-danger delete-ingredient-btn"
									data-ingredient-id="{{ ingredient.id }}" title="Remove ingredient">Ã—</button>
						</li>
						{% endfor %}
					</ul>
				</div>

				<!-- Manual ingredient input - justified to bottom -->
				<div class="manual-ingredient-input">
					<form method="POST" action="{{ url_for('add_manual_ingredient') }}" id="manual-ingredient-form">
						<div class="input-group mb-2">
							<input type="text" name="ingredient_text" class="form-control form-control-sm"
								   required id="manual-ingredient-input">
							<button type="submit" class="btn btn-sm btn-primary">Add</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>


<!-- Zipcode Modal -->
	<div class="modal-container" id="modal-zipcode">
		<div class="my-modal">
			<div class="details">
				<h1 class="title">Location Select</h1>
				<p class="description">
					Please enter your zipcode to find the nearest Kroger store
				</p>
			</div>
			<form
				method="POST"
				action="{{ url_for('location_search') }}"
				id="user_form"
			>
				<input type="text" name="zipcode" placeholder="Enter Zipcode" />
				<button type="submit">Next</button>
			</form>
			<p><a href="#modal-closed" class="btn">Cancel</a></p>
		</div>
	</div>

	<!-- Store Selection Modal -->
	<div class="modal-container" id="modal-store">
		<div class="my-modal">
			<div class="details">
				<h1 class="title">Store Select</h1>
				<p class="description">Please select the store you'd like to shop at</p>
			</div>
			<form method="POST" action="{{ url_for('select_store') }}" id="user_form">
				{% for address, city, location_id in session['stores'] %}
				<input type="radio" name="store_id" value="{{ location_id }}" />{{
				address }} {{ city }} {% endfor %}
				<button type="submit">Next</button>
			</form>
			<p>
				<a href="#modal-zipcode" class="btn">&larr; Previous</a>
				<a href="#modal-closed" class="btn">Cancel</a>
			</p>
		</div>
	</div>

	<!-- Ingredient Selection Modal -->
	<div class="modal-container" id="modal-ingredient">
		<div class="my-modal">
			<div class="details">
				<h1 class="title">Ingredient Select</h1>
				{% if session['current_ingredient_detail'] %}
				<p class="description">
					<strong>Looking for: {{ session['current_ingredient_detail']['quantity'] }} {{ session['current_ingredient_detail']['measurement'] }} {{ session['current_ingredient_detail']['name'] }}</strong><br>
					Please select the item you'd like to add to your cart
				</p>
				{% else %}
				<p class="description">
					Please select the item you'd like to add to your cart
				</p>
				{% endif %}
			</div>
			<form method="POST" action="{{ url_for('item_choice') }}" id="user_form">
				{% for item in session['items_to_choose_from'] %}
				<input type="radio" name="product_id" value="{{ item['id'] }}" />
				{{ item['name'] }} - ${{ item['price'] }} {% endfor %}
				<button type="submit">Next</button>
			</form>
			<form method="POST" action="{{ url_for('skip_ingredient') }}" style="display: inline;">
				<button type="submit" class="btn btn-outline-secondary">Skip</button>
			</form>
			<p>
				<a href="#modal-store" class="btn">&larr; Previous</a>
				<a href="#modal-closed" class="btn">Cancel</a>
			</p>
		</div>
	</div>

	<!-- Email Modal -->
<div id="email-modal" class="modal-container">
    <div class="my-modal">
        <div class="details">
            <h1 class="title">Email Grocery List & Recipes</h1>
            <p class="description">Enter your email address and choose what to send</p>
        </div>
        <form action="/send-email" method="post">
            <div class="form-group mb-3">
                <label for="email" class="form-label">Email:</label>
                <input type="email" id="email" name="email" class="form-control" required>
            </div>

            <!-- Email type selection -->
            <div class="email-type-selection mt-3 mb-3">
                <h5>What to send:</h5>
                <div class="form-check">
                    <input type="radio" name="email_type" value="recipes_only" class="form-check-input" id="recipes-only">
                    <label class="form-check-label" for="recipes-only">
                        Recipes Only
                    </label>
                </div>
                <div class="form-check">
                    <input type="radio" name="email_type" value="list_and_recipes" class="form-check-input" id="list-and-recipes" checked>
                    <label class="form-check-label" for="list-and-recipes">
                        Grocery List & Recipes
                    </label>
                </div>
            </div>

            <div class="recipe-selection mt-3">
                <h5>Include Recipes (optional):</h5>
                <div class="recipe-checkboxes" style="max-height: 200px; overflow-y: auto;">
                    {% for recipe in recipes %}
                    <div class="form-check">
                        <input type="checkbox" name="recipe_ids" value="{{ recipe.id }}" class="form-check-input email-recipe-checkbox"
                               id="email-recipe-{{ recipe.id }}">
                        <label class="form-check-label" for="email-recipe-{{ recipe.id }}">
                            {{ recipe.name }}
                        </label>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <button type="submit" class="button-56">Send Email</button>
        </form>
        <p><a href="#modal-closed" class="btn">Cancel</a></p>
    </div>
</div>

<script>
// Sync email modal checkboxes with recipe box checkboxes
document.getElementById('modal-closed').addEventListener('click', function() {
    // When opening email modal, sync checkboxes
    const recipeBoxCheckboxes = document.querySelectorAll('input[name="recipe_ids"]:not(.email-recipe-checkbox)');
    const emailCheckboxes = document.querySelectorAll('.email-recipe-checkbox');

    emailCheckboxes.forEach(emailCheckbox => {
        const recipeId = emailCheckbox.value;
        const correspondingRecipeBox = Array.from(recipeBoxCheckboxes).find(cb => cb.value === recipeId);
        if (correspondingRecipeBox) {
            emailCheckbox.checked = correspondingRecipeBox.checked;
        }
    });
});
</script>
</div>
{% endblock %}

{% block scripts %}
{% endblock %}
