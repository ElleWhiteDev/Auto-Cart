{% extends 'base.html' %}
{% block title %}Auto Cart - Smart Grocery Shopping{% endblock %}
{% block body_class %}homepage{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="text-center mb-6">
	<h1 class="text-4xl font-bold text-gray-900 mb-4">
		<i class="fas fa-shopping-cart text-primary mr-3"></i>
		Welcome to Auto Cart
	</h1>
	{% if g.household %}
	<p class="text-lg text-gray-600 max-w-2xl mx-auto">
		<i class="fas fa-home"></i> <strong>{{ g.household.name }}</strong> -
		Create and share recipes with your household members.
	</p>
	{% else %}
	<p class="text-lg text-gray-600 max-w-2xl mx-auto">
		Create smart grocery lists from your favorite recipes. Our AI-powered system
		consolidates ingredients and helps you shop more efficiently.
	</p>
	{% endif %}
</div>

<!-- Main Application Layout -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
	<!-- Recipe Box - Left Column -->
	<div class="recipe-box" data-collapsible="true">
		<div class="recipe-box-header" data-role="header">
			<h3><i class="fas fa-book-open mr-2"></i>Recipe Box</h3>
		</div>
		<form method="POST" action="{{ url_for('update_grocery_list') }}" class="p-0" data-role="body">
			<div class="recipe-list">
				{% for recipe in recipes %}
				<div class="recipe-item">
					<input
						type="checkbox"
						name="recipe_ids"
						value="{{ recipe.id }}"
						class="recipe-checkbox"
						id="recipe-{{ recipe.id }}"
						{% if recipe.id|string in selected_recipe_ids %}checked{% endif %}
					/>
					<label for="recipe-{{ recipe.id }}" class="recipe-name">
						{{ recipe.name }}
					</label>
				</div>
				{% endfor %}

				{% if not recipes %}
				<div class="text-center p-6 text-gray-500">
					<i class="fas fa-utensils text-4xl mb-3 text-gray-300"></i>
					<p>No recipes yet. Add your first recipe to get started!</p>
				</div>
				{% endif %}
			</div>
			<div class="p-4 border-top">
				<button type="submit" class="btn btn-primary w-100" id="update-grocery-list-btn">
					<i class="fas fa-sync-alt mr-2"></i>Update Grocery List
				</button>
			</div>
		</form>
	</div>

		<!-- Recipe Form - Middle Column -->
	<div class="form-container" data-collapsible="true">
		<div class="form-header" data-role="header">
			<h3><i class="fas fa-plus-circle mr-2"></i>Add New Recipe</h3>
		</div>
		<div class="form-body" data-role="body">
			<form method="POST" action="{{ url_for('add_recipe') }}" id="user_form" class="modal-form">
				{{ form.hidden_tag() }}

				<!-- Recipe Name -->
				<div class="form-group">
					{{ form.name.label(class="form-label") }}
					{{ form.name(class="form-input", placeholder="Enter recipe name") }}
					{% for error in form.name.errors %}
					<span class="text-sm text-error"> {{ error }} </span>
					{% endfor %}
				</div>

				<!-- Recipe URL -->
				<div class="form-group">
					{{ form.url.label(class="form-label") }}
					{{ form.url(class="form-input", placeholder="https://example.com/recipe") }}
					<div class="mt-2">
						<button type="button" id="extract-ai-btn" class="btn btn-secondary btn-sm">
							<span id="extract-spinner" class="d-none">⏳</span>
							<i class="fas fa-robot"></i> Extract with AI
						</button>
					</div>
					{% for error in form.url.errors %}
					<span class="text-sm text-error"> {{ error }} </span>
					{% endfor %}
				</div>

				<!-- Ingredients -->
				<div class="form-group">
					{{ form.ingredients_text.label(class="form-label") }}
					{{ form.ingredients_text(class="form-textarea", rows="6", placeholder="Enter ingredients, one per line...") }}
					<div class="mt-2">
						<button type="button" id="standardize-btn" class="btn btn-accent btn-sm">
							<span id="standardize-spinner" class="d-none">⏳</span>
							<i class="fas fa-magic"></i> Standardize Ingredients
						</button>
					</div>
					{% for error in form.ingredients_text.errors %}
					<span class="text-sm text-error"> {{ error }} </span>
					{% endfor %}
				</div>

				<!-- Notes -->
				<div class="form-group">
					{{ form.notes.label(class="form-label") }}
					{{ form.notes(class="form-textarea", rows="3", placeholder="Add cooking notes, instructions, or tips...") }}
					{% for error in form.notes.errors %}
					<span class="text-sm text-error"> {{ error }} </span>
					{% endfor %}
				</div>



				<div class="action-buttons">
					<button class="btn btn-primary btn-lg" type="submit">
						<i class="fas fa-plus mr-2"></i>Add Recipe
					</button>
				</div>
			</form>
		</div>
	</div>

	<!-- Grocery List - Full Width on Mobile, Half on Desktop -->
	<div class="grocery-list" data-collapsible="true">
		<div class="grocery-list-header" data-role="header">
			<h3 class="grocery-list-title">
				<i class="fas fa-list-ul mr-2"></i>
				{% if g.grocery_list %}
					{{ g.grocery_list.name }}
				{% else %}
					Your Grocery List
				{% endif %}
			</h3>
		</div>

		<div class="grocery-list-content" data-role="body">
			<!-- List Management Section -->
			<div class="mb-3">
				<!-- List Selector (if multiple lists exist) -->
				{% if all_grocery_lists and all_grocery_lists|length > 1 %}
				<div class="mb-2">
					<label for="listSelector" class="form-label small"><strong>Select List:</strong></label>
					<select id="listSelector" class="form-select form-select-sm" onchange="switchList(this.value)">
						{% for list in all_grocery_lists %}
						<option value="{{ list.id }}" {% if g.grocery_list and list.id == g.grocery_list.id %}selected{% endif %}>
							{{ list.name }}
						</option>
						{% endfor %}
					</select>
				</div>
				{% endif %}

				<!-- New List Form (collapsible) -->
				<div id="newListForm" style="display: none;" class="mb-2 p-3 border rounded bg-light">
					<form method="POST" action="{{ url_for('create_grocery_list') }}">
						<div class="mb-2">
							<label for="list_name" class="form-label small"><strong>New List Name:</strong></label>
							<input type="text" class="form-control form-control-sm" id="list_name" name="list_name" placeholder="e.g., Costco Trip, Weekly Shopping" required>
						</div>
						<div class="d-flex gap-2">
							<button type="submit" class="btn btn-sm btn-success flex-fill">
								<i class="fas fa-check"></i> Create
							</button>
							<button type="button" class="btn btn-sm btn-secondary flex-fill" onclick="toggleNewListForm()">
								<i class="fas fa-times"></i> Cancel
							</button>
						</div>
					</form>
				</div>

				<!-- Rename List Form (collapsible) -->
				{% if g.grocery_list %}
				<div id="renameListForm" style="display: none;" class="mb-2 p-3 border rounded bg-light">
					<form method="POST" action="{{ url_for('rename_grocery_list', list_id=g.grocery_list.id) }}">
						<div class="mb-2">
							<label for="rename_list_name" class="form-label small"><strong>Rename List:</strong></label>
							<input type="text" class="form-control form-control-sm" id="rename_list_name" name="list_name" value="{{ g.grocery_list.name }}" required>
						</div>
						<div class="d-flex gap-2">
							<button type="submit" class="btn btn-sm btn-primary flex-fill">
								<i class="fas fa-check"></i> Save
							</button>
							<button type="button" class="btn btn-sm btn-secondary flex-fill" onclick="toggleRenameListForm()">
								<i class="fas fa-times"></i> Cancel
							</button>
						</div>
					</form>
				</div>
				{% endif %}

				<!-- Action Buttons Row -->
				<div class="d-flex flex-column align-items-center gap-2">
					<!-- First row: New, Rename, Clear -->
					<div class="d-flex justify-content-center align-items-center" style="gap: 0.375rem;">
						<button type="button" class="btn btn-sm btn-success" onclick="toggleNewListForm()" style="min-width: 90px;">
							<i class="fas fa-plus mr-1"></i> New
						</button>
						{% if g.grocery_list %}
						<button type="button" class="btn btn-sm btn-outline-primary" onclick="toggleRenameListForm()" style="min-width: 90px;">
							<i class="fas fa-edit mr-1"></i> Rename
						</button>
						<button type="submit" form="clear-list-form" class="btn btn-sm btn-outline-warning" style="min-width: 90px;">
							<i class="fas fa-broom mr-1"></i> Clear
						</button>
						{% endif %}
					</div>

					<!-- Hidden form for Clear button -->
					{% if g.grocery_list %}
					<form id="clear-list-form" method="POST" action="{{ url_for('clear_grocery_list') }}" style="display: none;"></form>
					{% endif %}

					<!-- Second row: Shop -->
					{% if g.grocery_list %}
					<div class="d-flex justify-content-center align-items-center gap-2">
						<a href="{{ url_for('shopping_mode') }}" class="btn btn-sm btn-primary" style="min-width: 90px;">
							<i class="fas fa-shopping-cart mr-1"></i> Shop
						</a>
						{% if all_grocery_lists and all_grocery_lists|length > 1 %}
						<form method="POST" action="{{ url_for('delete_grocery_list', list_id=g.grocery_list.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this list?');">
							<button type="submit" class="btn btn-sm btn-outline-danger" style="min-width: 90px;">
								<i class="fas fa-trash mr-1"></i> Delete
							</button>
						</form>
						{% endif %}
					</div>
					{% endif %}
				</div>
			</div>

			<!-- Coordination Cues -->
			{% if g.grocery_list %}
			<div class="mb-3">
				{% if g.grocery_list.status == 'shopping' and g.grocery_list.shopping_user %}
				<div class="alert alert-info py-2 px-3 mb-2">
					<i class="fas fa-shopping-cart"></i>
					<strong>{{ g.grocery_list.shopping_user.username }}</strong> is currently shopping this list
				</div>
				{% endif %}

				{% if g.grocery_list.last_modified_by %}
				<div class="text-muted small">
					<i class="fas fa-clock"></i> Last updated by
					<strong>{{ g.grocery_list.last_modified_by.username }}</strong>
					{% if g.grocery_list.last_modified_at %}
					<span title="{{ g.grocery_list.last_modified_at|est_datetime('%Y-%m-%d %I:%M %p %Z') }}">
						{{ g.grocery_list.last_modified_at|est_datetime('%I:%M %p') }}
					</span>
					{% endif %}
				</div>
				{% endif %}
			</div>
			{% endif %}

			<!-- Action Buttons -->
			<div class="action-buttons mb-4">
				<a class="btn btn-secondary" href="#email-modal" id="email-modal-trigger">
					<i class="fas fa-envelope mr-2"></i>Email List
				</a>
				<button type="button" onclick="openKrogerAuth()" class="btn btn-accent">
					<i class="fas fa-shopping-cart mr-2"></i>Add to Cart
				</button>
			</div>

			<!-- Grocery Items -->
			{% if g.grocery_list %}
			<ul class="m-0">
				{% for ingredient in g.grocery_list.recipe_ingredients %}
				<li class="grocery-item" data-ingredient-id="{{ ingredient.id }}">
					<div class="grocery-item-content">
						<span class="grocery-item-text" onclick="editIngredient({{ ingredient.id }})">
							{% if ingredient.quantity and ingredient.quantity > 0 and ingredient.measurement %}
								<strong class="ingredient-quantity">{{ ingredient.quantity}} {{ ingredient.measurement }}</strong>
								<span class="ingredient-name">{{ ingredient.ingredient_name }}</span>
							{% else %}
								<span class="ingredient-name">{{ ingredient.ingredient_name }}</span>
							{% endif %}
						</span>
						<div class="grocery-item-edit" style="display: none;">
							<input type="number" class="edit-quantity" value="{{ ingredient.quantity or 1 }}" min="0" step="0.1" placeholder="Qty">
							<input type="text" class="edit-measurement" value="{{ ingredient.measurement or '' }}" placeholder="unit">
							<input type="text" class="edit-name" value="{{ ingredient.ingredient_name }}" placeholder="Ingredient name">
							<button type="button" class="btn-save" onclick="saveIngredient({{ ingredient.id }})">
								<i class="fas fa-check"></i>
							</button>
							<button type="button" class="btn-cancel" onclick="cancelEdit({{ ingredient.id }})">
								<i class="fas fa-times"></i>
							</button>
						</div>
					</div>
					<button type="button" class="grocery-item-remove delete-ingredient-btn"
							data-ingredient-id="{{ ingredient.id }}" title="Remove ingredient">
						<i class="fas fa-times"></i>
					</button>
				</li>
				{% endfor %}

				{% if not g.grocery_list.recipe_ingredients %}
				<li class="text-center p-6 text-gray-500">
					<i class="fas fa-shopping-basket text-4xl mb-3 text-gray-300"></i>
					<p>Your grocery list is empty. Select recipes to add ingredients!</p>
				</li>
				{% endif %}
			</ul>
			{% else %}
			<!-- No grocery list exists -->
			<div class="text-center p-6 text-gray-500">
				<i class="fas fa-exclamation-circle text-4xl mb-3 text-gray-300"></i>
				<p>No grocery list found. Please create a new list to get started!</p>
			</div>
			{% endif %}
		</div>

		<!-- Manual ingredient input -->
		{% if g.grocery_list %}
		<div class="p-4 border-top bg-gray-50">
			<form method="POST" action="{{ url_for('add_manual_ingredient') }}" id="manual-ingredient-form" onsubmit="handleManualIngredientSubmit(event)">
				<div class="d-flex gap-2">
					<input type="text" name="ingredient_text" class="form-input flex-1"
						   placeholder="e.g., 2 cups flour or just milk" id="manual-ingredient-input">
					<button type="submit" class="btn btn-primary" id="manual-ingredient-submit-btn" style="min-width: 60px;">
						<i class="fas fa-plus"></i>
					</button>
				</div>
			</form>
		</div>
		{% endif %}
	</div>
</div>
<!-- Modals -->
<!-- Zipcode Modal -->
<div class="modal-container" id="modal-zipcode">
	<div class="my-modal">
		<div class="modal-header">
			<h2 class="modal-title">
				<i class="fas fa-map-marker-alt text-primary mr-2"></i>
				Location Select
			</h2>
			<p class="modal-description">
				Please enter your zipcode to find the nearest Kroger store
			</p>
		</div>
		<div class="modal-body">
			<form method="POST" action="{{ url_for('location_search') }}" class="modal-form">
				<div class="form-group">
					<label for="zipcode" class="form-label">Zipcode:</label>
					<input type="text" name="zipcode" id="zipcode" placeholder="Enter Zipcode" class="form-input" required />
				</div>
				<div class="modal-actions">
					<a href="#modal-closed" class="btn btn-outline">
						<i class="fas fa-times mr-2"></i>Cancel
					</a>
					<button type="submit" class="btn btn-primary">
						<i class="fas fa-search mr-2"></i>Find Stores
					</button>
				</div>
			</form>
		</div>
	</div>
</div>

<!-- Store Selection Modal -->
<div class="modal-container" id="modal-store">
	<div class="my-modal">
		<div class="modal-header">
			<h2 class="modal-title">
				<i class="fas fa-store text-primary mr-2"></i>
				Store Select
			</h2>
			<p class="modal-description">Please select the store you'd like to shop at</p>
		</div>
		<div class="modal-body">
			<form method="POST" action="{{ url_for('select_store') }}" class="modal-form">
				<div class="selection-options">
					{% for address, city, location_id in session['stores'] %}
					<div class="selection-option">
						<input type="radio" name="store_id" value="{{ location_id }}" id="store-{{ loop.index }}" class="selection-radio" />
						<label for="store-{{ loop.index }}" class="selection-label">
							<div class="font-semibold text-gray-800">{{ address }}</div>
							<div class="text-sm text-gray-600">{{ city }}</div>
						</label>
					</div>
					{% endfor %}
				</div>
				<div class="modal-actions">
					<a href="#modal-zipcode" class="btn btn-outline">
						<i class="fas fa-arrow-left mr-2"></i>Back
					</a>
					<button type="submit" class="btn btn-primary">
						<i class="fas fa-arrow-right mr-2"></i>Continue
					</button>
					<a href="#modal-closed" class="btn btn-outline">
						<i class="fas fa-times mr-2"></i>Cancel
					</a>
				</div>
			</form>
		</div>
	</div>
</div>

<!-- Ingredient Selection Modal -->
<div class="modal-container" id="modal-ingredient">
	<div class="my-modal">
		<div class="modal-header">
			<h2 class="modal-title">
				<i class="fas fa-shopping-basket text-primary mr-2"></i>
				Select Product
			</h2>
			{% if session['current_ingredient_detail'] %}
			<div class="ingredient-highlight">
				<div class="ingredient-label">Looking for:</div>
				<div class="ingredient-name">
					{{ session['current_ingredient_detail']['quantity'] }} {{ session['current_ingredient_detail']['measurement'] }} {{ session['current_ingredient_detail']['name'] }}
				</div>
			</div>
			<p class="modal-description">
				Select the item you'd like to add to your cart, or search for a different product below
			</p>
			{% else %}
			<p class="modal-description">
				Please select the item you'd like to add to your cart
			</p>
			{% endif %}
		</div>
		<div class="modal-body">
			<!-- Custom Search Input -->
			<div class="custom-search-container">
				<form method="POST" action="{{ url_for('kroger_product_search') }}" id="custom-search-form">
					<label for="custom-search" class="form-label">
						<i class="fas fa-search mr-2"></i>Can't find what you're looking for?
					</label>
					<div class="search-input-group">
						<input type="text" id="custom-search" name="custom_search"
							   class="form-input"
							   placeholder="e.g., organic chicken breast" />
						<button type="submit" class="btn btn-primary" id="search-btn">
							<i class="fas fa-search mr-2"></i>Search
						</button>
					</div>
				</form>
			</div>

			<form method="POST" action="{{ url_for('item_choice') }}" id="ingredient-selection-form" onsubmit="return validateIngredientSelection()">
				<div class="selection-options">
					{% for item in session['items_to_choose_from'] %}
					<div class="selection-option">
						<input type="checkbox" name="product_id" value="{{ item['id'] }}" id="product-{{ loop.index }}" class="selection-checkbox" />
						<label for="product-{{ loop.index }}" class="selection-label">
							<div class="flex gap-4 items-center">
								{% if item['image_url'] %}
								<div class="w-16 h-16 flex-shrink-0">
									<img src="{{ item['image_url'] }}" alt="{{ item['name'] }}"
										 class="w-full h-full object-cover rounded-lg"
										 onerror="this.style.display='none';" />
								</div>
								{% endif %}
								<div class="flex-1">
									<div class="font-semibold text-gray-800">{{ item['name'] }}</div>
									{% if item['brand'] %}
									<div class="text-sm text-gray-600">{{ item['brand'] }}</div>
									{% endif %}
									{% if item['size'] %}
									<div class="text-sm text-gray-500">{{ item['size'] }}</div>
									{% endif %}
									{% if item.get('aisle') %}
									<div class="text-sm text-gray-500">
										<i class="fas fa-map-marker-alt mr-1"></i>{{ item['aisle'] }}
									</div>
									{% endif %}
									<div class="flex items-center gap-2">
										<div class="text-lg font-bold text-primary">${{ item['price'] }}</div>
										{% if item.get('available') == False %}
										<span class="availability-badge unavailable">
											<i class="fas fa-exclamation-circle mr-1"></i>Unavailable
										</span>
										{% elif item.get('available') == True %}
										<span class="availability-badge available">
											<i class="fas fa-check-circle mr-1"></i>Available
										</span>
										{% endif %}
									</div>
								</div>
								<div class="quantity-container">
									<label for="quantity-{{ loop.index }}" class="quantity-label">Qty:</label>
									<input type="number" name="quantity" id="quantity-{{ loop.index }}"
										   min="1" value="1"
										   class="quantity-input"
										   onclick="event.stopPropagation();" />
								</div>
							</div>
						</label>
					</div>
					{% endfor %}
				</div>
				<div class="modal-actions">
					<a href="#modal-store" class="btn btn-outline">
						<i class="fas fa-arrow-left mr-2"></i>Back
					</a>
					<button type="button" onclick="document.getElementById('skip-form').submit();" class="btn btn-outline">
						<i class="fas fa-forward mr-2"></i>Skip
					</button>
					<button type="submit" class="btn btn-primary" id="add-to-cart-btn">
						<i class="fas fa-cart-plus mr-2"></i>Add to Cart
					</button>
				</div>
			</form>
			<form method="POST" action="{{ url_for('skip_ingredient') }}" id="skip-form" style="display: none;">
			</form>
		</div>
	</div>
</div>

<!-- Skipped Ingredients Modal -->
<div class="modal-container" id="modal-skipped">
	<div class="my-modal">
		<div class="modal-header">
			<h2 class="modal-title">
				<i class="fas fa-exclamation-triangle text-warning mr-2"></i>
				Skipped Ingredients
			</h2>
			<p class="modal-description">
				The following ingredients were skipped and won't be added to your cart:
			</p>
		</div>
		<div class="modal-body">
			{% if session.get('skipped_ingredients') %}
			<div style="background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
				<ul style="margin: 0; padding-left: 20px;">
					{% for ingredient in session.get('skipped_ingredients', []) %}
					<li style="margin-bottom: 8px; color: #856404;">{{ ingredient }}</li>
					{% endfor %}
				</ul>
			</div>
			<p style="color: #666; font-size: 14px;">
				<i class="fas fa-info-circle mr-2"></i>
				You can manually add these items to your cart later if needed.
			</p>
			{% endif %}
			<div class="modal-actions">
				<a href="#modal-closed" class="btn btn-outline">
					<i class="fas fa-arrow-left mr-2"></i>Go Back
				</a>
				<a href="{{ url_for('kroger_send_to_cart', confirmed='true') }}" class="btn btn-primary">
					<i class="fas fa-check mr-2"></i>Continue to Kroger
				</a>
			</div>
		</div>
	</div>
</div>

<!-- Email Modal -->
<div id="email-modal" class="modal-container">
    <div class="my-modal email-modal-content">
        <div class="modal-header">
            <h2 class="modal-title">
                <i class="fas fa-envelope text-primary mr-2"></i>
                Email Grocery List & Recipes
            </h2>
            <p class="modal-description">Send your grocery list and recipes to any email address</p>
        </div>
        <div class="modal-body">
            <form action="/send-email" method="post" class="modal-form">
                <!-- User Email Selection -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-users mr-1"></i>Select Recipients
                    </label>
                    <div class="email-selection-box">
                        <!-- Current User (You) -->
                        <div class="recipe-item">
                            <input type="checkbox" name="user_emails" value="{{ g.user.email }}"
                                   class="recipe-checkbox"
                                   id="user-email-self"
                                   checked>
                            <label class="recipe-name" for="user-email-self">
                                <strong>{{ g.user.username }} (You)</strong> - {{ g.user.email }}
                            </label>
                        </div>

                        <!-- Other Users -->
                        {% if all_users %}
                            {% for user in all_users %}
                                {% if user.id != g.user.id %}
                                <div class="recipe-item">
                                    <input type="checkbox" name="user_emails" value="{{ user.email }}"
                                           class="recipe-checkbox"
                                           id="user-email-{{ user.id }}">
                                    <label class="recipe-name" for="user-email-{{ user.id }}">
                                        {{ user.username }} ({{ user.email }})
                                    </label>
                                </div>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>

                <!-- Custom Email Input -->
                <div class="form-group">
                    <label for="custom-email" class="form-label">
                        <i class="fas fa-at mr-1"></i>Or Enter Custom Email
                        <span class="text-sm text-gray-500 font-normal">(optional)</span>
                    </label>
                    <input type="email" id="custom-email" name="custom_email" class="form-input"
                           placeholder="someone@example.com">
                </div>

                <!-- Email Type Selection -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-list-check mr-1"></i>What to send
                    </label>
                    <div class="selection-options">
                        <div class="selection-option">
                            <input type="radio" name="email_type" value="list_and_recipes"
                                   id="list-and-recipes" class="selection-radio" checked>
                            <label for="list-and-recipes" class="selection-label">
                                <div class="font-semibold text-gray-800">
                                    <i class="fas fa-shopping-basket mr-1"></i>Grocery List & Recipes
                                </div>
                                <div class="text-sm text-gray-600">Complete list with selected recipes</div>
                            </label>
                        </div>
                        <div class="selection-option">
                            <input type="radio" name="email_type" value="recipes_only"
                                   id="recipes-only" class="selection-radio">
                            <label for="recipes-only" class="selection-label">
                                <div class="font-semibold text-gray-800">
                                    <i class="fas fa-book-open mr-1"></i>Recipes Only
                                </div>
                                <div class="text-sm text-gray-600">Just the recipes, no grocery list</div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Recipe Selection -->
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-utensils mr-1"></i>Select Recipes to Include
                        <span class="text-sm text-gray-500 font-normal">(optional)</span>
                    </label>
                    <div class="recipe-selection-box">
                        {% if recipes %}
                            {% for recipe in recipes %}
                            <div class="recipe-item">
                                <input type="checkbox" name="recipe_ids" value="{{ recipe.id }}"
                                       class="recipe-checkbox email-recipe-checkbox"
                                       id="email-recipe-{{ recipe.id }}">
                                <label class="recipe-name" for="email-recipe-{{ recipe.id }}">
                                    {{ recipe.name }}
                                </label>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-gray-500 text-center py-3">
                                <i class="fas fa-info-circle mr-1"></i>No recipes available
                            </p>
                        {% endif %}
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="modal-actions">
                    <a href="#modal-closed" class="btn btn-outline">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </a>
                    <button type="submit" class="btn btn-primary" id="send-email-btn">
                        <i class="fas fa-paper-plane mr-2"></i>Send Email
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Mobile Accordion Functionality
document.addEventListener('DOMContentLoaded', () => {
  const collapsibleSections = document.querySelectorAll('[data-collapsible="true"]');

  // On mobile, collapse all sections by default EXCEPT grocery list
  if (window.innerWidth <= 768) {
    collapsibleSections.forEach(section => {
      // Keep grocery list open, close others
      if (section.classList.contains('grocery-list')) {
        section.classList.add('is-open');
      } else {
        section.classList.remove('is-open');
      }
    });
  }

  // Add click handlers to headers
  collapsibleSections.forEach(section => {
    const header = section.querySelector('[data-role="header"]');
    if (!header) return;

    header.addEventListener('click', () => {
      // Only enable accordion on mobile
      if (window.innerWidth > 768) return;

      section.classList.toggle('is-open');
    });
  });

  // Re-check on window resize
  window.addEventListener('resize', () => {
    if (window.innerWidth > 768) {
      // On desktop, ensure all sections are open
      collapsibleSections.forEach(section => {
        section.classList.add('is-open');
      });
    }
  });
});

// Add loading state to Update Grocery List button
const updateGroceryListForm = document.querySelector('form[action="/update_grocery_list"]');
const updateGroceryListBtn = document.getElementById('update-grocery-list-btn');

if (updateGroceryListForm && updateGroceryListBtn) {
    updateGroceryListForm.addEventListener('submit', function() {
        // Show loading state
        updateGroceryListBtn.disabled = true;
        updateGroceryListBtn.innerHTML = '<span class="spinner-border spinner-border-sm mr-2" role="status"></span>Processing...';
    });
}

// Add loading state to Add Recipe button
const addRecipeForm = document.getElementById('user_form');
const addRecipeBtn = addRecipeForm ? addRecipeForm.querySelector('button[type="submit"]') : null;

if (addRecipeForm && addRecipeBtn) {
    addRecipeForm.addEventListener('submit', function() {
        // Show loading state
        addRecipeBtn.disabled = true;
        addRecipeBtn.innerHTML = '<span class="spinner-border spinner-border-sm mr-2" role="status"></span>Adding Recipe...';
    });
}

// Sync email modal checkboxes with recipe box checkboxes
document.getElementById('email-modal-trigger').addEventListener('click', function() {
    // When opening email modal, sync checkboxes
    const recipeBoxCheckboxes = document.querySelectorAll('input[name="recipe_ids"]:not(.email-recipe-checkbox)');
    const emailCheckboxes = document.querySelectorAll('.email-recipe-checkbox');

    emailCheckboxes.forEach(emailCheckbox => {
        const recipeId = emailCheckbox.value;
        const correspondingRecipeBox = Array.from(recipeBoxCheckboxes).find(cb => cb.value === recipeId);
        if (correspondingRecipeBox) {
            emailCheckbox.checked = correspondingRecipeBox.checked;
        }
    });
});

// Validate ingredient selection - at least one item must be selected
function validateIngredientSelection() {
    const checkboxes = document.querySelectorAll('#ingredient-selection-form input[type="checkbox"]:checked');
    if (checkboxes.length === 0) {
        alert('Please select at least one item to add to your cart, or click "Skip" to continue.');
        return false;
    }
    return true;
}

// Close modal when clicking outside of it
document.addEventListener('DOMContentLoaded', function() {
    const modalContainers = document.querySelectorAll('.modal-container');

    modalContainers.forEach(container => {
        container.addEventListener('click', function(e) {
            // Only close if clicking directly on the modal-container (backdrop), not its children
            if (e.target === container) {
                // Navigate to #modal-closed to close the modal
                window.location.hash = 'modal-closed';
            }
        });
    });
});

// Add loading state to search button
const searchForm = document.getElementById('custom-search-form');
const searchBtn = document.getElementById('search-btn');

if (searchForm && searchBtn) {
    searchForm.addEventListener('submit', function() {
        searchBtn.disabled = true;
        searchBtn.innerHTML = '<span class="spinner-border spinner-border-sm mr-2" role="status"></span>Searching...';
    });
}

// Add loading state to send email button
const emailForm = document.querySelector('#email-modal form');
const sendEmailBtn = document.getElementById('send-email-btn');

if (emailForm && sendEmailBtn) {
    emailForm.addEventListener('submit', function() {
        sendEmailBtn.disabled = true;
        sendEmailBtn.innerHTML = '<span class="spinner-border spinner-border-sm mr-2" role="status"></span>Sending...';
    });
}

// Add loading state to add to cart button
const ingredientForm = document.getElementById('ingredient-selection-form');
const addToCartBtn = document.getElementById('add-to-cart-btn');

if (ingredientForm && addToCartBtn) {
    ingredientForm.addEventListener('submit', function() {
        addToCartBtn.disabled = true;
        addToCartBtn.innerHTML = '<span class="spinner-border spinner-border-sm mr-2" role="status"></span>Adding...';
    });
}

// Grocery list item editing functions
function editIngredient(ingredientId) {
    const item = document.querySelector(`li[data-ingredient-id="${ingredientId}"]`);
    if (!item) return;

    const textSpan = item.querySelector('.grocery-item-text');
    const editDiv = item.querySelector('.grocery-item-edit');

    textSpan.style.display = 'none';
    editDiv.style.display = 'flex';

    // Focus on the name input
    const nameInput = editDiv.querySelector('.edit-name');
    nameInput.focus();
    nameInput.select();
}

function cancelEdit(ingredientId) {
    const item = document.querySelector(`li[data-ingredient-id="${ingredientId}"]`);
    if (!item) return;

    const textSpan = item.querySelector('.grocery-item-text');
    const editDiv = item.querySelector('.grocery-item-edit');

    textSpan.style.display = 'inline';
    editDiv.style.display = 'none';
}

async function saveIngredient(ingredientId) {
    const item = document.querySelector(`li[data-ingredient-id="${ingredientId}"]`);
    if (!item) return;

    const editDiv = item.querySelector('.grocery-item-edit');
    const quantity = editDiv.querySelector('.edit-quantity').value;
    const measurement = editDiv.querySelector('.edit-measurement').value;
    const name = editDiv.querySelector('.edit-name').value.trim();

    if (!name) {
        alert('Ingredient name cannot be empty');
        return;
    }

    try {
        const formData = new FormData();
        formData.append('ingredient_id', ingredientId);
        formData.append('quantity', quantity);
        formData.append('measurement', measurement);
        formData.append('name', name);

        const response = await fetch('/update_ingredient', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            // Update the display text
            const textSpan = item.querySelector('.grocery-item-text');
            const quantityNum = parseFloat(quantity);

            if (quantityNum > 0 && measurement) {
                textSpan.innerHTML = `<strong class="ingredient-quantity">${quantity} ${measurement}</strong> <span class="ingredient-name">${name}</span>`;
            } else {
                textSpan.innerHTML = `<span class="ingredient-name">${name}</span>`;
            }

            cancelEdit(ingredientId);
        } else {
            alert(result.error || 'Failed to update ingredient');
        }
    } catch (error) {
        alert('Network error. Please try again.');
    }
}

// Toggle new list form visibility
function toggleNewListForm() {
    const form = document.getElementById('newListForm');
    if (form.style.display === 'none') {
        form.style.display = 'block';
    } else {
        form.style.display = 'none';
    }
}

// Switch to a different grocery list
function switchList(listId) {
    if (!listId) return;

    // Create a form and submit it
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/grocery-list/switch/${listId}`;
    document.body.appendChild(form);
    form.submit();
}

// Toggle rename list form visibility
function toggleRenameListForm() {
    const form = document.getElementById('renameListForm');
    if (form.style.display === 'none') {
        form.style.display = 'block';
        // Hide new list form if it's open
        document.getElementById('newListForm').style.display = 'none';
    } else {
        form.style.display = 'none';
    }
}

// Handle manual ingredient form submission
async function handleManualIngredientSubmit(event) {
    event.preventDefault();
    event.stopPropagation();

    const form = event.target;
    const input = document.getElementById('manual-ingredient-input');
    const submitBtn = document.getElementById('manual-ingredient-submit-btn');
    const ingredientText = input.value.trim();

    if (!ingredientText) {
        alert('Please enter an ingredient');
        return false;
    }

    // Show loading state
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

    try {
        const formData = new FormData();
        formData.append('ingredient_text', ingredientText);

        const response = await fetch('/add_manual_ingredient', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            // Success - reload the page to show updated list
            window.location.reload();
        } else {
            // Error - show message and restore button
            alert(result.error || 'Failed to add ingredient');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-plus"></i>';
        }
    } catch (error) {
        console.error('Error adding ingredient:', error);
        alert('Network error. Please try again.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-plus"></i>';
    }

    return false;
}
</script>

{% endblock %}
