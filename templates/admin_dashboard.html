{% extends 'base.html' %}

{% block title %}Admin Dashboard - Auto Cart{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
	<div class="d-flex justify-content-between align-items-center mb-4">
		<h1><i class="fas fa-shield-alt text-dark"></i> Admin Dashboard</h1>
		<div>
			<span class="badge bg-dark me-2">
				<i class="fas fa-user-shield"></i> Logged in as: {{ g.user.username }}
			</span>
			<a href="{{ url_for('homepage') }}" class="btn btn-outline-primary">
				<i class="fas fa-home"></i> Back to App
			</a>
			<a href="{{ url_for('logout') }}" class="btn btn-outline-danger">
				<i class="fas fa-sign-out-alt"></i> Logout
			</a>
		</div>
	</div>

	<!-- Feature Announcement Section -->
	<div class="card shadow mb-4" style="border-left: 4px solid #f97316;">
		<div class="card-header" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white;">
			<h3 class="mb-0">
				<i class="fas fa-bullhorn"></i> Feature Announcements
			</h3>
		</div>
		<div class="card-body">
			<div class="d-flex justify-content-between align-items-center">
				<div>
					<h5 class="mb-2">Send Latest Feature Email</h5>
					<p class="text-muted mb-0">
						<i class="fas fa-info-circle"></i>
						Sends the latest feature announcement email to all registered users.
						Update <code>templates/feature_announcement_email.html</code> before sending.
					</p>
				</div>
				<form method="POST" action="{{ url_for('send_feature_announcement') }}" style="display: inline;"
				      onsubmit="return confirm('Are you sure you want to send the feature announcement email to ALL {{ users|length }} registered users? This action cannot be undone.');">
					<button type="submit" class="btn btn-lg" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; font-weight: bold;">
						<i class="fas fa-paper-plane"></i> Send to All Users ({{ users|length }})
					</button>
				</form>
			</div>
		</div>
	</div>

	<div class="card shadow">
		<div class="card-header bg-dark text-white">
			<h3 class="mb-0">
				<i class="fas fa-users"></i> All Users ({{ users|length }})
			</h3>
		</div>
		<div class="card-body p-0">
			<div class="table-responsive">
				<table class="table table-hover table-striped mb-0">
					<thead class="table-dark">
						<tr>
							<th>ID</th>
							<th>Username</th>
							<th>Email</th>
							<th>Admin</th>
							<th>Last Activity</th>
							<th>Kroger Connected</th>
							<th>Actions</th>
						</tr>
					</thead>
					<tbody>
						{% for user in users %}
						<tr>
							<td>{{ user.id }}</td>
							<td>
								<strong>{{ user.username }}</strong>
								{% if user.id == g.user.id %}
								<span class="badge bg-primary ms-1">You</span>
								{% endif %}
							</td>
							<td>{{ user.email }}</td>
							<td>
								{% if user.is_admin %}
								<span class="badge bg-success">
									<i class="fas fa-check"></i> Admin
								</span>
								{% else %}
								<span class="badge bg-secondary">User</span>
								{% endif %}
							</td>
							<td>
								{% if user.last_activity %}
								<span title="{{ user.last_activity }}">
									{{ user.last_activity.strftime('%Y-%m-%d %H:%M UTC') }}
								</span>
								{% else %}
								<span class="text-muted">Never</span>
								{% endif %}
							</td>
							<td>
								{% if user.oauth_token %}
								<span class="badge bg-success">
									<i class="fas fa-check"></i> Yes
								</span>
								{% else %}
								<span class="badge bg-secondary">No</span>
								{% endif %}
							</td>
							<td>
								{% if user.id != g.user.id %}
								<form method="POST" action="{{ url_for('admin_delete_user', user_id=user.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete user {{ user.username }}? This action cannot be undone.');">
									<button type="submit" class="btn btn-sm btn-danger">
										<i class="fas fa-trash"></i> Delete
									</button>
								</form>
								{% else %}
								<span class="text-muted">—</span>
								{% endif %}
							</td>
						</tr>
						{% endfor %}

						{% if not users %}
						<tr>
							<td colspan="7" class="text-center text-muted p-4">
								<i class="fas fa-users-slash fa-3x mb-3"></i>
								<p>No users found</p>
							</td>
						</tr>
						{% endif %}
					</tbody>
				</table>
			</div>
		</div>
	</div>

	<!-- Households Section -->
	<div class="card shadow mt-4">
		<div class="card-header bg-primary text-white">
			<h3 class="mb-0">
				<i class="fas fa-home"></i> All Households ({{ household_stats|length }})
			</h3>
		</div>
		<div class="card-body p-0">
			<div class="table-responsive">
				<table class="table table-hover table-striped mb-0">
					<thead class="table-primary">
						<tr>
							<th>ID</th>
							<th>Name</th>
							<th>Owner</th>
							<th>Members</th>
							<th>Recipes</th>
							<th>Lists</th>
							<th>Meals</th>
							<th>Created</th>
							<th>Actions</th>
						</tr>
					</thead>
					<tbody>
						{% for stat in household_stats %}
						<tr>
							<td>{{ stat.household.id }}</td>
							<td><strong>{{ stat.household.name }}</strong></td>
							<td>
								{% if stat.owner %}
								{{ stat.owner.username }}
								{% else %}
								<span class="text-muted">No owner</span>
								{% endif %}
							</td>
							<td>
								<span class="badge bg-info">{{ stat.members_count }}</span>
								{% if stat.email_enabled_count is defined %}
								<br><small class="text-muted">{{ stat.email_enabled_count }} meal plan emails</small>
								{% endif %}
								{% if stat.chef_email_enabled_count is defined %}
								<br><small class="text-muted">{{ stat.chef_email_enabled_count }} chef emails</small>
								{% endif %}
							</td>
							<td>
								<span class="badge bg-success">{{ stat.recipes_count }}</span>
							</td>
							<td>
								<span class="badge bg-warning text-dark">{{ stat.lists_count }}</span>
							</td>
							<td>
								<span class="badge bg-secondary">{{ stat.meals_count }}</span>
							</td>
							<td>
								{% if stat.household.created_at %}
								{{ stat.household.created_at.strftime('%Y-%m-%d') }}
								{% else %}
								<span class="text-muted">—</span>
								{% endif %}
							</td>
							<td>
								<button type="button" class="btn btn-sm btn-info me-1" onclick="showMembersModal({{ stat.household.id }}, '{{ stat.household.name }}')">
									<i class="fas fa-users-cog"></i> Manage
								</button>
								<form method="POST" action="{{ url_for('admin_delete_household', household_id=stat.household.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete household {{ stat.household.name }}? This will delete {{ stat.members_count }} memberships, {{ stat.recipes_count }} recipes, {{ stat.lists_count }} lists, and {{ stat.meals_count }} meals. This action cannot be undone.');">
									<button type="submit" class="btn btn-sm btn-danger">
										<i class="fas fa-trash"></i> Delete
									</button>
								</form>
							</td>
						</tr>
						{% endfor %}

						{% if not household_stats %}
						<tr>
							<td colspan="9" class="text-center text-muted p-4">
								<i class="fas fa-home fa-3x mb-3"></i>
								<p>No households found</p>
							</td>
						</tr>
						{% endif %}
					</tbody>
				</table>
			</div>
		</div>
	</div>

	<!-- Stats Cards -->
	<div class="row mt-4">
		<div class="col-md-3">
			<div class="card">
				<div class="card-body text-center">
					<h4 class="text-primary">{{ users|length }}</h4>
					<p class="text-muted mb-0">Total Users</p>
				</div>
			</div>
		</div>
		<div class="col-md-3">
			<div class="card">
				<div class="card-body text-center">
					<h4 class="text-success">{{ users|selectattr('is_admin')|list|length }}</h4>
					<p class="text-muted mb-0">Admin Users</p>
				</div>
			</div>
		</div>
		<div class="col-md-3">
			<div class="card">
				<div class="card-body text-center">
					<h4 class="text-info">{{ users|selectattr('oauth_token')|list|length }}</h4>
					<p class="text-muted mb-0">Kroger Connected</p>
				</div>
			</div>
		</div>
		<div class="col-md-3">
			<div class="card">
				<div class="card-body text-center">
					<h4 class="text-warning">{{ household_stats|length }}</h4>
					<p class="text-muted mb-0">Total Households</p>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Manage Members Modal -->
<div class="modal fade" id="manageMembersModal" tabindex="-1" aria-labelledby="manageMembersModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="manageMembersModalLabel">
					<i class="fas fa-users-cog"></i> Manage Members - <span id="householdName"></span>
				</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<div id="membersLoadingSpinner" class="text-center py-4">
					<div class="spinner-border text-primary" role="status">
						<span class="visually-hidden">Loading...</span>
					</div>
					<p class="mt-2 text-muted">Loading members...</p>
				</div>
				<div id="membersContent" style="display: none;">
					<div class="table-responsive">
						<table class="table table-hover">
							<thead>
								<tr>
									<th>Username</th>
									<th>Email</th>
									<th>Role</th>
									<th class="text-center">Meal Plan Emails</th>
									<th class="text-center">Chef Emails</th>
								</tr>
							</thead>
							<tbody id="membersTableBody">
								<!-- Members will be loaded here -->
							</tbody>
						</table>
					</div>
				</div>
				<div id="membersError" class="alert alert-danger" style="display: none;"></div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
			</div>
		</div>
	</div>
</div>

<script>
// Add processing states to all delete buttons
document.addEventListener('DOMContentLoaded', function() {
	// Delete user buttons
	const deleteUserForms = document.querySelectorAll('form[action*="admin/delete-user"]');
	deleteUserForms.forEach(form => {
		form.addEventListener('submit', function(e) {
			const btn = form.querySelector('button[type="submit"]');
			if (btn) {
				// Confirmation is handled by onsubmit attribute
				setTimeout(() => {
					btn.disabled = true;
					btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Deleting...';
				}, 10);
			}
		});
	});

	// Delete household buttons
	const deleteHouseholdForms = document.querySelectorAll('form[action*="admin/delete-household"]');
	deleteHouseholdForms.forEach(form => {
		form.addEventListener('submit', function(e) {
			const btn = form.querySelector('button[type="submit"]');
			if (btn) {
				// Confirmation is handled by onsubmit attribute
				setTimeout(() => {
					btn.disabled = true;
					btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Deleting...';
				}, 10);
			}
		});
	});
});

// Show members modal and load members
function showMembersModal(householdId, householdName) {
	const modal = new bootstrap.Modal(document.getElementById('manageMembersModal'));
	document.getElementById('householdName').textContent = householdName;
	document.getElementById('membersLoadingSpinner').style.display = 'block';
	document.getElementById('membersContent').style.display = 'none';
	document.getElementById('membersError').style.display = 'none';

	modal.show();

	// Load members
	fetch(`/admin/household/${householdId}/members`)
		.then(response => response.json())
		.then(data => {
			if (data.success) {
				displayMembers(data.members);
				document.getElementById('membersLoadingSpinner').style.display = 'none';
				document.getElementById('membersContent').style.display = 'block';
			} else {
				showError(data.error || 'Failed to load members');
			}
		})
		.catch(error => {
			console.error('Error loading members:', error);
			showError('Failed to load members. Please try again.');
		});
}

function displayMembers(members) {
	const tbody = document.getElementById('membersTableBody');
	tbody.innerHTML = '';

	members.forEach(member => {
		const row = document.createElement('tr');
		row.innerHTML = `
			<td><strong>${escapeHtml(member.username)}</strong></td>
			<td>${escapeHtml(member.email)}</td>
			<td>
				<span class="badge bg-${member.role === 'owner' ? 'primary' : 'secondary'}">
					${member.role === 'owner' ? 'Owner' : 'Member'}
				</span>
			</td>
			<td class="text-center">
				<div class="form-check form-switch d-inline-block">
					<input
						class="form-check-input"
						type="checkbox"
						id="mealPlanEmail_${member.member_id}"
						${member.receive_meal_plan_emails ? 'checked' : ''}
						onchange="toggleMemberEmail(${member.member_id}, 'meal_plan', this.checked, '${escapeHtml(member.username)}')"
					>
				</div>
			</td>
			<td class="text-center">
				<div class="form-check form-switch d-inline-block">
					<input
						class="form-check-input"
						type="checkbox"
						id="chefEmail_${member.member_id}"
						${member.receive_chef_assignment_emails ? 'checked' : ''}
						onchange="toggleMemberEmail(${member.member_id}, 'chef', this.checked, '${escapeHtml(member.username)}')"
					>
				</div>
			</td>
		`;
		tbody.appendChild(row);
	});
}

function toggleMemberEmail(memberId, emailType, enabled, username) {
	const checkbox = document.getElementById(`${emailType === 'meal_plan' ? 'mealPlanEmail' : 'chefEmail'}_${memberId}`);
	const originalState = checkbox.checked;

	fetch('/admin/toggle-member-email', {
		method: 'POST',
		headers: {
			'Content-Type': 'application/json',
		},
		body: JSON.stringify({
			member_id: memberId,
			email_type: emailType,
			enabled: enabled
		})
	})
	.then(response => response.json())
	.then(data => {
		if (data.success) {
			// Show success feedback
			const emailTypeName = emailType === 'meal_plan' ? 'meal plan' : 'chef assignment';
			console.log(`${emailTypeName} emails ${enabled ? 'enabled' : 'disabled'} for ${username}`);
		} else {
			// Revert checkbox on error
			checkbox.checked = !enabled;
			alert(data.error || 'Failed to update email preference');
		}
	})
	.catch(error => {
		console.error('Error toggling email:', error);
		checkbox.checked = !enabled;
		alert('Failed to update email preference. Please try again.');
	});
}

function showError(message) {
	document.getElementById('membersLoadingSpinner').style.display = 'none';
	document.getElementById('membersContent').style.display = 'none';
	document.getElementById('membersError').textContent = message;
	document.getElementById('membersError').style.display = 'block';
}

function escapeHtml(text) {
	const div = document.createElement('div');
	div.textContent = text;
	return div.innerHTML;
}
</script>
{% endblock %}
