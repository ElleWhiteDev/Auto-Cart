{% extends 'base.html' %}

{% block title %}{{ household.name }} - Settings{% endblock %}

{% block content %}
<div class="row">
	<div class="col-12">
		<h1><i class="fas fa-cog"></i> Household Settings</h1>
		<p class="text-muted">Manage your households, members, and integrations</p>
	</div>
</div>

<!-- 1. My Households Section -->
<div class="row mt-4">
	<div class="col-12">
		<div class="card">
			<div class="card-header">
				<h3 class="h5 mb-0"><i class="fas fa-home"></i> My Households</h3>
			</div>
			<div class="card-body">
				{% if user_households and user_households|length > 0 %}
				<p class="text-muted mb-3">
					{% if user_households|length > 1 %}
					You are a member of {{ user_households|length }} households. Click to switch between them.
					{% else %}
					You are currently a member of 1 household. Create additional households to organize different groups (family, roommates, etc.).
					{% endif %}
				</p>
				<div class="list-group mb-3">
					{% for hh in user_households %}
					{% set hh_membership = g.user.household_memberships|selectattr('household_id', 'equalto', hh.id)|first %}
					<div class="list-group-item {% if hh.id == household.id %}active{% endif %}">
						<div class="d-flex justify-content-between align-items-center mb-2">
							<div>
								<strong>
									<i class="fas fa-home"></i> {{ hh.name }}
								</strong>
								{% if hh.id == household.id %}
								<span class="badge badge-light ml-2">Current</span>
								{% endif %}
								{% for membership in g.user.household_memberships %}
									{% if membership.household_id == hh.id %}
										{% if membership.is_owner() %}
										<span class="badge badge-primary ml-2">Owner</span>
										{% else %}
										<span class="badge badge-secondary ml-2">Member</span>
										{% endif %}
									{% endif %}
								{% endfor %}
							</div>
							{% if hh.id != household.id %}
							<a href="{{ url_for('switch_household', household_id=hh.id) }}" class="btn btn-sm btn-primary">
								<i class="fas fa-exchange-alt"></i> Switch
							</a>
							{% endif %}
						</div>
						{% if hh_membership %}
						<div class="d-flex justify-content-between align-items-center pt-2" style="border-top: 1px solid rgba(0,0,0,0.1);">
							<div>
								<small><i class="fas fa-envelope"></i> <strong>Meal Plan Emails</strong></small>
								<br>
								<small class="text-muted">Daily summaries of meal plan changes</small>
							</div>
							<div class="form-check form-switch">
								<input
									class="form-check-input"
									type="checkbox"
									id="email-toggle-{{ hh_membership.id }}"
									{% if hh_membership.receive_meal_plan_emails %}checked{% endif %}
									onchange="toggleMealPlanEmails({{ hh_membership.id }}, this.checked)"
									style="cursor: pointer;"
								>
							</div>
						</div>
						<div class="d-flex justify-content-between align-items-center pt-2" style="border-top: 1px solid rgba(0,0,0,0.1);">
							<div>
								<small><i class="fas fa-utensils"></i> <strong>Chef Assignment Emails</strong></small>
								<br>
								<small class="text-muted">Notifications when you're assigned to cook</small>
							</div>
							<div class="form-check form-switch">
								<input
									class="form-check-input"
									type="checkbox"
									id="chef-email-toggle-{{ hh_membership.id }}"
									{% if hh_membership.receive_chef_assignment_emails %}checked{% endif %}
									onchange="toggleChefAssignmentEmails({{ hh_membership.id }}, this.checked)"
									style="cursor: pointer;"
								>
							</div>
						</div>
						{% endif %}
					</div>
					{% endfor %}
				</div>
				{% else %}
				<p class="text-muted mb-3">
					You are not a member of any households. Create your first household to get started!
				</p>
				{% endif %}

				<!-- Always show Create New Household button -->
				<div>
					<a href="{{ url_for('create_household') }}" class="btn btn-success">
						<i class="fas fa-plus"></i> Create New Household
					</a>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- 2. Household Info Section -->
<div class="row mt-4">
	<div class="col-12">
		<div class="card">
			<div class="card-header">
				<h3 class="h5 mb-0"><i class="fas fa-info-circle"></i> Household Info</h3>
			</div>
			<div class="card-body">
				<div class="row">
					<div class="col-md-6">
						<p class="mb-2">
							<strong>Household Name:</strong> {{ household.name }}
						</p>
						<p class="mb-2">
							<strong>Created:</strong> {{ household.created_at.strftime('%B %d, %Y') if household.created_at else 'N/A' }}
						</p>
						<p class="mb-2">
							<strong>Members:</strong> {{ members|length }}
						</p>
						<p class="mb-0">
							<strong>Your Role:</strong>
							<span class="badge badge-{% if is_owner %}primary{% else %}secondary{% endif %}">
								{{ 'Owner' if is_owner else 'Member' }}
							</span>
						</p>
					</div>
					{% if is_owner %}
					<div class="col-md-6">
						<h4 class="h6 mb-3"><i class="fas fa-edit"></i> Edit Household Name</h4>
						<form method="POST" action="{{ url_for('edit_household_name') }}" id="edit-name-form">
							<div class="mb-3">
								<input
									type="text"
									class="form-control"
									name="household_name"
									value="{{ household.name }}"
									placeholder="Household name"
									required
								/>
							</div>
							<div class="d-flex gap-2">
								<button type="submit" class="btn btn-primary flex-fill" id="edit-name-btn">
									<i class="fas fa-save"></i> Save
								</button>
								<button type="button" class="btn btn-danger flex-fill" id="delete-household-trigger-btn" onclick="confirmDeleteHousehold()">
									<i class="fas fa-trash-alt"></i> Delete Household
								</button>
							</div>
						</form>
						<p class="text-muted small mt-2 mb-0">
							<i class="fas fa-exclamation-triangle text-danger"></i> Deleting the household will permanently remove all associated recipes, grocery lists, and meal plans.
						</p>
						<!-- Hidden delete form -->
						<form method="POST" action="{{ url_for('delete_household') }}" id="delete-household-form" style="display: none;">
						</form>
					</div>
					{% endif %}
				</div>
			</div>
		</div>
	</div>
</div>

<!-- 3. House Members Section -->
<div class="row mt-4">
	<div class="col-12">
		<div class="card">
			<div class="card-header">
				<h3 class="h5 mb-0"><i class="fas fa-users"></i> House Members</h3>
			</div>
			<div class="card-body">
				<div class="table-responsive">
					<table class="table table-hover">
						<thead>
							<tr>
								<th>Username</th>
								<th>Email</th>
								<th>Role</th>
								<th>Last Login</th>
								{% if is_owner %}
								<th style="width: 60px;">Action</th>
								{% endif %}
							</tr>
						</thead>
						<tbody>
							{% for member in members %}
							<tr>
								<td>
									<i class="fas fa-user"></i> {{ member.user.username }}
									{% if member.user.id == g.user.id %}
									<span class="badge badge-secondary ml-1">You</span>
									{% endif %}
								</td>
								<td>{{ member.user.email }}</td>
								<td>
									<span class="badge badge-{% if member.is_owner() %}primary{% else %}secondary{% endif %}">
										{{ 'Owner' if member.is_owner() else 'Member' }}
									</span>
								</td>
								<td>
									{% if member.user.last_activity %}
									{{ member.user.last_activity.strftime('%b %d, %Y %I:%M %p') }}
									{% else %}
									<span class="text-muted">Never</span>
									{% endif %}
								</td>
								{% if is_owner %}
								<td>
									{% if member.user.id != g.user.id %}
									<form method="POST" action="{{ url_for('remove_household_member', user_id=member.user.id) }}" style="display: inline;">
										<button type="submit" class="btn btn-danger btn-sm" style="padding: 0.1rem 0.3rem; font-size: 0.65rem;" onclick="return confirm('Remove {{ member.user.username }} from household?')" title="Remove">
											<i class="fas fa-times"></i>
										</button>
									</form>
									{% endif %}
								</td>
								{% endif %}
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>

				{% if is_owner %}
				<div class="mt-4 pt-3" style="border-top: 1px solid #e9ecef;">
					<h4 class="h6 mb-3"><i class="fas fa-user-plus"></i> Invite Member</h4>
					<form method="POST" action="{{ url_for('invite_household_member') }}" class="d-flex gap-2" id="invite-form">
						<input
							type="text"
							class="form-control"
							name="username"
							placeholder="Enter username or email"
							required
						/>
						<button type="submit" class="btn btn-primary" id="invite-btn">
							<i class="fas fa-plus"></i> Invite
						</button>
					</form>
					<small class="form-text text-muted mt-2">
						Enter a username or email address. If the email doesn't exist in our system, we'll send them an invitation to register.
					</small>
				</div>
				{% endif %}
			</div>
		</div>
	</div>
</div>

<!-- 4. Kroger Integration Section -->
<div class="row mt-4">
	<div class="col-12">
		<div class="card">
			<div class="card-header">
				<h3 class="h5 mb-0"><i class="fas fa-shopping-bag"></i> Kroger Integration</h3>
			</div>
			<div class="card-body">
				{% if kroger_user %}
				<div class="alert alert-success">
					<i class="fas fa-check-circle"></i>
					<strong>Connected</strong><br>
					Using <strong>{{ kroger_user.username }}</strong>'s Kroger account for household shopping.
				</div>
				{% else %}
				<div class="alert alert-warning">
					<i class="fas fa-exclamation-triangle"></i>
					<strong>Not Connected</strong><br>
					No Kroger account is set for this household.
				</div>
				{% endif %}

				{% if is_owner %}
				<div class="mt-3">
					<h4 class="h6 mb-3">Set Kroger Account</h4>
					<p class="text-muted small mb-3">
						Choose which household member's Kroger account to use for sending grocery lists to cart.
					</p>
					{% for member in members %}
					{% if member.user.oauth_token %}
					<form method="POST" action="{{ url_for('set_kroger_user', user_id=member.user.id) }}" class="mb-2">
						<button type="submit" class="btn btn-sm {% if kroger_user and kroger_user.id == member.user.id %}btn-success{% else %}btn-outline-primary{% endif %} w-100">
							{% if kroger_user and kroger_user.id == member.user.id %}
							<i class="fas fa-check"></i>
							{% endif %}
							Use {{ member.user.username }}'s Kroger Account
						</button>
					</form>
					{% endif %}
					{% endfor %}

					{% if not members|selectattr('user.oauth_token')|list %}
					<p class="text-muted small mb-0">
						<i class="fas fa-info-circle"></i> No household members have connected their Kroger account yet.
					</p>
					{% endif %}
				</div>
				{% endif %}
			</div>
		</div>
	</div>
</div>

<div class="row mt-4">
	<div class="col-12">
		<a href="{{ url_for('homepage') }}" class="btn btn-secondary">
			<i class="fas fa-arrow-left"></i> Back to Recipes
		</a>
	</div>
</div>

<script>
	// Add processing state to invite button
	const inviteForm = document.getElementById('invite-form');
	const inviteBtn = document.getElementById('invite-btn');

	if (inviteForm && inviteBtn) {
		inviteForm.addEventListener('submit', function() {
			inviteBtn.disabled = true;
			inviteBtn.innerHTML = '<span class="spinner-border spinner-border-sm mr-2" role="status" aria-hidden="true"></span>Sending...';
		});
	}

	// Add processing state to edit household name button
	const editNameForm = document.getElementById('edit-name-form');
	const editNameBtn = document.getElementById('edit-name-btn');

	if (editNameForm && editNameBtn) {
		editNameForm.addEventListener('submit', function() {
			editNameBtn.disabled = true;
			editNameBtn.innerHTML = '<span class="spinner-border spinner-border-sm mr-2" role="status" aria-hidden="true"></span>Saving...';
		});
	}

	// Add processing state to all remove member buttons
	const removeForms = document.querySelectorAll('form[action*="remove-member"]');
	removeForms.forEach(form => {
		form.addEventListener('submit', function(e) {
			const btn = form.querySelector('button[type="submit"]');
			if (btn && confirm(btn.getAttribute('onclick').match(/'([^']+)'/)[1])) {
				btn.disabled = true;
				btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
			} else {
				e.preventDefault();
			}
		});
	});

	// Delete household confirmation function
	function confirmDeleteHousehold() {
		const householdName = "{{ household.name }}";
		const deleteBtn = document.getElementById('delete-household-trigger-btn');
		const deleteForm = document.getElementById('delete-household-form');

		const confirmed = confirm(`⚠️ WARNING: This will permanently delete the household "${householdName}" and ALL associated recipes, grocery lists, and meal plans.\n\nThis action CANNOT be undone.\n\nAre you sure you want to continue?`);

		if (confirmed) {
			// Show loading state
			deleteBtn.disabled = true;
			deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Deleting...';

			// Submit the form
			deleteForm.submit();
		}
	}

	// Toggle meal plan email notifications
	function toggleMealPlanEmails(memberId, enabled) {
		const checkbox = document.getElementById('email-toggle-' + memberId);

		// Disable checkbox during request
		checkbox.disabled = true;

		fetch('{{ url_for("toggle_meal_plan_emails") }}', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
			},
			body: JSON.stringify({
				member_id: memberId,
				enabled: enabled
			})
		})
		.then(response => response.json())
		.then(data => {
			if (data.success) {
				// Success - checkbox state is already updated
				console.log('Email preference updated successfully');
			} else {
				// Revert checkbox on error
				checkbox.checked = !enabled;
				alert('Error updating email preference: ' + (data.error || 'Unknown error'));
			}
		})
		.catch(error => {
			// Revert checkbox on error
			checkbox.checked = !enabled;
			alert('Error updating email preference. Please try again.');
			console.error('Error:', error);
		})
		.finally(() => {
			checkbox.disabled = false;
		});
	}

	// Toggle chef assignment email notifications
	function toggleChefAssignmentEmails(memberId, enabled) {
		const checkbox = document.getElementById('chef-email-toggle-' + memberId);

		// Disable checkbox during request
		checkbox.disabled = true;

		fetch('{{ url_for("toggle_chef_assignment_emails") }}', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
			},
			body: JSON.stringify({
				member_id: memberId,
				enabled: enabled
			})
		})
		.then(response => response.json())
		.then(data => {
			if (data.success) {
				// Success - checkbox state is already updated
				console.log('Chef assignment email preference updated successfully');
			} else {
				// Revert checkbox on error
				checkbox.checked = !enabled;
				alert('Error updating chef assignment email preference: ' + (data.error || 'Unknown error'));
			}
		})
		.catch(error => {
			// Revert checkbox on error
			checkbox.checked = !enabled;
			alert('Error updating chef assignment email preference. Please try again.');
			console.error('Error:', error);
		})
		.finally(() => {
			checkbox.disabled = false;
		});
	}
</script>
{% endblock %}
